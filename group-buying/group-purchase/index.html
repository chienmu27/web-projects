<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¾½çƒéšŠåœ˜è³¼ç³»çµ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
  body { font-family: 'Noto Sans TC', sans-serif; background-color: #f9fafb; -webkit-tap-highlight-color: transparent; }
  .category-btn.active { background-color: #ef4444; color: white; border-color: #ef4444; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .modal { transition: opacity 0.2s ease; }
  body.modal-active { overflow: hidden; }
</style>
</head>
<body class="pb-20 text-gray-800">

<header class="bg-red-600 text-white shadow-md sticky top-0 z-40">
  <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
    <h1 class="text-2xl font-bold flex items-center gap-2 shrink-0"><i class="fas fa-feather-pointed"></i> ç¾½çƒéšŠåœ˜è³¼</h1>
    <div class="flex items-center gap-4 flex-1 justify-center w-full md:w-auto">
        <div class="bg-red-800 p-1.5 rounded-xl flex text-base font-bold shadow-inner">
            <button onclick="switchView('client')" id="btn-view-client" class="px-5 py-2 rounded-lg bg-white text-red-800 shadow transition whitespace-nowrap">è¨‚è³¼å•†å“</button>
            <button onclick="switchView('admin')" id="btn-view-admin" class="px-5 py-2 rounded-lg text-red-200 hover:text-white transition whitespace-nowrap">è¨‚è³¼æŸ¥è©¢</button>
        </div>
        <div onclick="toggleCart()" class="flex items-center gap-3 cursor-pointer bg-red-700 hover:bg-red-800 px-5 py-2 rounded-full transition shadow-lg border border-red-500">
            <span class="text-lg font-bold whitespace-nowrap">æª¢æŸ¥è³¼ç‰©è»Š</span>
            <div class="relative">
                <i class="fas fa-shopping-cart text-2xl"></i>
                <span id="header-cart-count" class="absolute -top-2 -right-3 bg-yellow-400 text-red-800 text-xs font-black px-2 py-0.5 rounded-full border-2 border-red-600">0</span>
            </div>
        </div>
    </div>
    <div class="hidden md:block w-32"></div>
  </div>
</header>

<div id="view-client">
    <div class="bg-orange-50 border-b border-orange-100 p-4">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
            <div class="w-full md:w-2/3 overflow-hidden">
                <marquee id="marquee-text" class="text-xl text-gray-700 font-bold bg-transparent py-1 px-2" scrollamount="6">è¼‰å…¥ä¸­...</marquee>
            </div>
            <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                <button onclick="openNameModal()" class="flex-1 md:flex-none bg-white border border-orange-200 text-orange-700 px-4 py-2 rounded-full shadow-sm hover:bg-orange-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-user-edit"></i> <span id="display-name">è¨­å®šè¨‚è³¼äºº</span>
                </button>
            </div>
        </div>
    </div>

    <nav id="category-nav" class="sticky top-[80px] md:top-[88px] bg-white/95 backdrop-blur border-b overflow-x-auto whitespace-nowrap z-30 px-4 py-3 flex gap-2 no-scrollbar shadow-sm">
        <button onclick="filterMenu('all')" class="category-btn active px-4 py-1.5 rounded-full border border-gray-300 text-sm font-medium transition">å…¨éƒ¨</button>
    </nav>

    <main class="container mx-auto p-4 min-h-[50vh]">
        <div id="loading-spinner" class="text-center py-20 text-gray-400">
            <i class="fas fa-circle-notch fa-spin text-4xl mb-3 text-red-400"></i>
            <p>æ­£åœ¨è¼‰å…¥ç”¢å“...</p>
        </div>
        <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>
</div>

<div id="view-admin" class="hidden container mx-auto p-4">
    <div class="flex flex-wrap gap-2 md:gap-4 border-b mb-6 overflow-x-auto no-scrollbar">
        <button onclick="switchAdminTab('orders')" id="tab-orders" class="px-4 py-2 font-bold whitespace-nowrap text-red-600 border-b-2 border-red-600">è¨‚å–®ç®¡ç†</button>
        <button onclick="switchAdminTab('history')" id="tab-history" class="px-4 py-2 font-bold whitespace-nowrap text-gray-400 hover:text-gray-600">è¨‚å–®ç¸½è¡¨</button>
        <button onclick="switchAdminTab('menu')" id="tab-menu" class="px-4 py-2 font-bold whitespace-nowrap text-gray-400 hover:text-gray-600">ç”¢å“ç®¡ç†</button>
    </div>
    <div id="admin-orders-panel"><div class="flex justify-between items-center mb-4"><p id="admin-status" class="text-sm text-gray-500">è¼‰å…¥ä¸­...</p><button onclick="loadAdminOrders()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded text-sm transition"><i class="fas fa-sync-alt mr-1"></i> åˆ·æ–°</button></div><div id="admin-orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
    <div id="admin-history-panel" class="hidden"><div class="bg-white rounded-xl shadow-sm border p-4 mb-4"><h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-filter text-red-500"></i> æŸ¥è©¢æ¢ä»¶</h3><div class="grid grid-cols-1 md:grid-cols-5 gap-3"><select id="hist-filter-date" class="border rounded-lg px-3 py-2 bg-gray-50 text-sm focus:ring-2 focus:ring-red-500 focus:outline-none" onchange="applyHistoryFilters()"><option value="all">è¼‰å…¥ä¸­...</option></select><select id="hist-filter-item" class="border rounded-lg px-3 py-2 bg-gray-50 text-sm focus:ring-2 focus:ring-red-500 focus:outline-none" onchange="applyHistoryFilters()"><option value="all">æ‰€æœ‰å“é …</option></select><select id="hist-filter-name" class="border rounded-lg px-3 py-2 bg-gray-50 text-sm focus:ring-2 focus:ring-red-500 focus:outline-none" onchange="applyHistoryFilters()"><option value="all">æ‰€æœ‰äººå“¡</option></select><button onclick="resetHistoryFilters()" class="bg-gray-200 text-gray-600 rounded-lg px-3 py-2 text-sm font-bold hover:bg-gray-300 transition">é‡ç½®</button><button onclick="triggerDeleteAllOrders()" class="bg-red-600 text-white rounded-lg px-3 py-2 text-sm font-bold shadow hover:bg-red-700 transition">åˆªé™¤å…¨éƒ¨</button></div></div><div class="bg-white rounded-xl shadow-sm border overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-50 border-b"><tr><th class="px-4 py-3">æ—¥æœŸ</th><th class="px-4 py-3">å§“å</th><th class="px-4 py-3">å“é …</th><th class="px-4 py-3 text-right">å–®åƒ¹</th><th class="px-4 py-3 text-center">æ•¸é‡</th><th class="px-4 py-3 text-right">å°è¨ˆ</th><th class="px-4 py-3 text-center">ç‹€æ…‹</th><th class="px-4 py-3 text-center">æ“ä½œ</th></tr></thead><tbody id="history-tbody" class="divide-y divide-gray-100"></tbody></table></div><div class="bg-red-50 border-t p-4 flex justify-end items-center gap-4 text-red-800 font-bold"><div>ç¸½é‡ï¼š<span id="hist-total-qty">0</span></div><div>ç¸½é¡ï¼š<span id="hist-total-amt">$0</span></div></div></div></div>
    <div id="admin-menu-panel" class="hidden"><div class="flex justify-between items-center mb-4"><p class="text-sm text-gray-500">ç®¡ç†ç¾æœ‰ç”¢å“</p><div class="flex gap-2"><button onclick="loadAdminMenu()" class="bg-gray-100 px-3 py-1.5 rounded text-sm"><i class="fas fa-sync-alt"></i></button><button onclick="openMenuModal('add')" class="bg-red-600 text-white px-3 py-1.5 rounded text-sm font-bold"><i class="fas fa-plus"></i> æ–°å¢</button></div></div><div class="overflow-x-auto bg-white rounded-xl shadow border"><table class="w-full text-sm text-left"><thead class="bg-gray-50 border-b"><tr><th class="px-4 py-3">åœ–ç‰‡</th><th class="px-4 py-3">é¡åˆ¥</th><th class="px-4 py-3">åç¨±</th><th class="px-4 py-3 hidden md:table-cell">æè¿°</th><th class="px-4 py-3">åƒ¹æ ¼</th><th class="px-4 py-3 text-center">æ“ä½œ</th></tr></thead><tbody id="admin-menu-tbody" class="divide-y divide-gray-100"></tbody></table></div></div>
</div>

<div id="cart-sidebar" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[60] flex flex-col">
  <div class="p-4 border-b flex justify-between items-center bg-gray-50"><h3 class="font-bold text-lg"><i class="fas fa-shopping-bag text-red-500 mr-2"></i>å·²é¸ç”¢å“</h3><button onclick="toggleCart()" class="text-gray-400 text-2xl">&times;</button></div>
  <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-3"></div>
  <div class="p-4 border-t bg-gray-50"><div class="flex justify-between mb-4 items-end"><span class="text-gray-600 text-sm">ç¸½è¨ˆ</span><span class="text-red-600 font-black text-2xl" id="total-price">$0</span></div><button id="btn-submit" onclick="submitOrder()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3.5 rounded-xl font-bold shadow-lg transition">é€å‡ºè¨‚å–®</button></div>
</div>
<div id="overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/40 hidden z-50"></div>

<!-- Modals -->
<div id="modal-name" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70]"><div class="modal-overlay absolute w-full h-full bg-black/50" onclick="closeNameModal()"></div><div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 p-6 transform scale-95 transition-transform"><h3 class="text-xl font-bold mb-4">ğŸ‘‹ è¨­å®šè¨‚è³¼äºº</h3><input id="input-name" type="text" class="w-full bg-gray-50 border-2 rounded-xl px-4 py-3 focus:border-red-500 outline-none mb-4" placeholder="ä¾‹å¦‚ï¼šé˜¿èƒ–"><button onclick="saveName()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl shadow">ç¢ºå®š</button></div></div>
<div id="modal-auth" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[80]"><div class="modal-overlay absolute w-full h-full bg-black/60" onclick="closeAuthModal()"></div><div class="modal-container bg-white w-11/12 md:max-w-sm mx-auto rounded-2xl p-6 shadow-2xl z-50"><h3 class="text-xl font-bold mb-2" id="auth-title">é©—è­‰èº«åˆ†</h3><p class="text-gray-500 text-sm mb-4" id="auth-desc">è«‹è¼¸å…¥é©—è­‰ç¢¼</p><input id="input-auth-pwd" type="password" inputmode="numeric" class="w-full text-center tracking-widest text-2xl border rounded-xl px-4 py-2 mb-4 focus:ring-2 focus:ring-red-500 outline-none"><div class="flex gap-3"><button onclick="closeAuthModal()" class="flex-1 bg-gray-100 py-2 rounded-lg">å–æ¶ˆ</button><button id="btn-auth-confirm" class="flex-1 bg-red-600 text-white py-2 rounded-lg shadow">ç¢ºèª</button></div></div></div>

<!-- Modified Menu Edit Modal with Image Upload -->
<div id="modal-menu-edit" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70]">
    <div class="modal-overlay absolute w-full h-full bg-black/50" onclick="closeMenuModal()"></div>
    <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl p-6 shadow-2xl z-50 max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4" id="menu-modal-title">ç·¨è¼¯å“é …</h3>
        <input type="hidden" id="menu-row-id">
        <input type="hidden" id="menu-current-img">
        <div class="space-y-3">
            <div>
                <label class="text-xs font-bold text-gray-500">ç”¢å“ç…§ç‰‡</label>
                <div class="mt-1 flex items-center gap-3">
                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden border flex-shrink-0 relative">
                        <img id="menu-img-preview" src="" class="w-full h-full object-cover hidden">
                        <div id="menu-img-placeholder" class="w-full h-full flex items-center justify-center text-gray-300">
                            <i class="fas fa-image text-xl"></i>
                        </div>
                    </div>
                    <!-- åŠ å…¥ accept="image/png, image/jpeg" æ˜ç¢ºé™åˆ¶æ ¼å¼ -->
                    <input type="file" id="menu-img-input" accept="image/png, image/jpeg, image/jpg" class="text-sm text-gray-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100" onchange="handleFileSelect(this)">
                </div>
                <p class="text-xs text-gray-400 mt-1">* ç³»çµ±æœƒè‡ªå‹•å£“ç¸®åœ–ç‰‡ä»¥åŠ å¿«ä¸Šå‚³é€Ÿåº¦</p>
            </div>
            <div><label class="text-xs font-bold text-gray-500">åˆ†é¡</label><input id="menu-cat" type="text" class="w-full border rounded-lg px-3 py-2"></div>
            <div><label class="text-xs font-bold text-gray-500">åç¨±</label><input id="menu-name" type="text" class="w-full border rounded-lg px-3 py-2"></div>
            <div><label class="text-xs font-bold text-gray-500">åƒ¹æ ¼</label><input id="menu-price" type="number" class="w-full border rounded-lg px-3 py-2"></div>
            <div><label class="text-xs font-bold text-gray-500">æè¿°</label><textarea id="menu-desc" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea></div>
        </div>
        <div class="mt-6 flex gap-3">
            <button onclick="closeMenuModal()" class="flex-1 bg-gray-100 py-2 rounded-lg">å–æ¶ˆ</button>
            <button onclick="triggerMenuSave()" id="btn-menu-save" class="flex-1 bg-blue-600 text-white py-2 rounded-lg shadow">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>
</div>

<script>
// è«‹ç¢ºä¿é€™è£¡å¡«å…¥çš„æ˜¯æ‚¨æœ€æ–°çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzZh7SZLScf3JitSON8sMFXcPEF5umYW0Px7IRhtDRdlOPRJ5EF4p199STCQKgSN5iH/exec"; 

let menuData = [];
let cart = [];
let historyData = [];
let userName = localStorage.getItem("apan_user_name") || "";
let currentView = "client";
let pendingImageBase64 = null; // ç”¨ä¾†æš«å­˜å£“ç¸®å¾Œçš„åœ–ç‰‡è³‡æ–™

window.onload = () => {
    if(userName) updateNameDisplay();
    fetchMenu();
};

async function callApi(payload) {
    try {
        const res = await fetch(GAS_API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload)
        });
        return await res.json();
    } catch (e) { return { ok: false, message: "ç¶²è·¯éŒ¯èª¤" }; }
}

function switchView(view) {
    currentView = view;
    document.getElementById('view-client').classList.toggle('hidden', view !== 'client');
    document.getElementById('view-admin').classList.toggle('hidden', view !== 'admin');
    document.getElementById('btn-view-client').className = view === 'client' ? "px-5 py-2 rounded-lg bg-white text-red-800 shadow transition" : "px-5 py-2 rounded-lg text-red-200 hover:text-white transition";
    document.getElementById('btn-view-admin').className = view === 'admin' ? "px-5 py-2 rounded-lg bg-white text-red-800 shadow transition" : "px-5 py-2 rounded-lg text-red-200 hover:text-white transition";
    if(view === 'admin') loadAdminOrders();
}

function switchAdminTab(tab) {
    ['orders', 'history', 'menu'].forEach(t => {
        const btn = document.getElementById(`tab-${t}`);
        const active = t === tab;
        btn.className = `px-4 py-2 font-bold transition ${active ? 'text-red-600 border-b-2 border-red-600' : 'text-gray-400'}`;
        document.getElementById(`admin-${t}-panel`).classList.toggle('hidden', !active);
    });
    if(tab === 'orders') loadAdminOrders();
    if(tab === 'history') loadHistoryData();
    if(tab === 'menu') loadAdminMenu();
}

// --- å‰å°é‚è¼¯ ---
async function fetchMenu() {
    const res = await callApi({ action: "getMenu" });
    if (res.ok) {
        menuData = res.data;
        if(res.marquee) document.getElementById('marquee-text').innerText = res.marquee;
        renderCategoryNav();
        displayMenu(menuData);
        document.getElementById('loading-spinner').style.display = 'none';
    }
}

function renderCategoryNav() {
    const cats = ['all', ...new Set(menuData.map(i => i.category))];
    const html = cats.map(c => `<button onclick="filterMenu('${c}')" class="category-btn ${c==='all'?'active':''} px-4 py-1.5 rounded-full border text-sm transition">${c==='all'?'å…¨éƒ¨':c}</button>`).join('');
    document.getElementById('category-nav').innerHTML = html;
}

function filterMenu(c) {
    document.querySelectorAll('.category-btn').forEach(b => b.classList.toggle('active', b.innerText === (c==='all'?'å…¨éƒ¨':c)));
    displayMenu(c === 'all' ? menuData : menuData.filter(i => i.category === c));
}

function displayMenu(items) {
    const container = document.getElementById('menu-container');
    if(!items.length) { container.innerHTML = '<p class="col-span-full text-center py-10 text-gray-400">ç„¡ç”¢å“</p>'; return; }
    
    container.innerHTML = items.map(i => {
        const inCart = cart.find(c => c.row === i.row);
        const qty = inCart ? inCart.qty : 0;
        
        // åœ–ç‰‡è™•ç†é‚è¼¯
        const imgHtml = i.image 
            ? `<img src="${i.image}" class="w-full h-40 object-cover bg-gray-200" loading="lazy">` 
            : `<div class="w-full h-40 bg-gray-100 flex items-center justify-center text-gray-300"><i class="fas fa-image text-4xl"></i></div>`;

        const btnHtml = qty === 0 
            ? `<button onclick="updateItemQty(${i.row}, 1)" class="bg-red-50 text-red-600 font-bold px-4 py-2 rounded-full w-full">åŠ å…¥</button>`
            : `<div class="flex items-center justify-between bg-red-600 text-white rounded-full w-full px-1 py-1"><button onclick="updateItemQty(${i.row}, -1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full">&minus;</button><span class="font-bold">${qty}</span><button onclick="updateItemQty(${i.row}, 1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full">&plus;</button></div>`;

        return `<div class="bg-white rounded-2xl shadow-sm border overflow-hidden flex flex-col justify-between hover:shadow-md transition">
            ${imgHtml}
            <div class="p-4 flex-1 flex flex-col justify-between">
                <div>
                    <span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-bold">${i.category}</span>
                    <h3 class="font-bold text-lg mt-1">${i.name}</h3>
                    <p class="text-xs text-gray-400 line-clamp-2">${i.desc}</p>
                </div>
                <div class="flex justify-between items-end mt-3">
                    <p class="text-red-600 font-black text-lg">$${i.price}</p>
                    <div class="w-28">${btnHtml}</div>
                </div>
            </div>
        </div>`;
    }).join('');
}

function updateItemQty(rowId, delta) {
    const idx = cart.findIndex(c => c.row === rowId);
    if (idx !== -1) {
        cart[idx].qty += delta;
        if (cart[idx].qty <= 0) cart.splice(idx, 1);
    } else if (delta > 0) {
        const item = menuData.find(m => m.row === rowId);
        if(item) cart.push({...item, qty: 1});
    }
    updateCartUI();
    const btnContainer = document.querySelector(`#menu-container button[onclick="updateItemQty(${rowId}, 1)"]`)?.parentNode;
    if(btnContainer) {
        displayMenu(currentView === 'client' && document.querySelector('.category-btn.active').innerText !== 'å…¨éƒ¨' 
            ? menuData.filter(i => i.category === document.querySelector('.category-btn.active').innerText) 
            : menuData);
    }
}

function updateCartUI() {
    let total = 0, count = 0;
    const html = cart.map(c => {
        total += c.price * c.qty; count += c.qty;
        return `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl"><div class="flex-1"><div class="font-bold">${c.name}</div><div class="text-xs text-gray-500">$${c.price}</div></div><div class="flex items-center gap-2 bg-white px-2 py-1 rounded border"><button onclick="updateItemQty(${c.row},-1)">&minus;</button><span class="font-bold w-4 text-center">${c.qty}</span><button onclick="updateItemQty(${c.row},1)">&plus;</button></div><div class="w-12 text-right font-bold">$${c.price*c.qty}</div></div>`;
    }).join('');
    document.getElementById('cart-items').innerHTML = html || '<div class="text-center text-gray-400 py-10">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>';
    document.getElementById('header-cart-count').innerText = count;
    document.getElementById('total-price').innerText = `$${total}`;
}

// --- é€šç”¨ UI é‚è¼¯ ---
function toggleCart() { document.getElementById('cart-sidebar').classList.toggle('translate-x-full'); document.getElementById('overlay').classList.toggle('hidden'); document.body.classList.toggle('modal-active'); }
function openNameModal() { document.getElementById('modal-name').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('input-name').value = userName; }
function closeNameModal() { document.getElementById('modal-name').classList.add('opacity-0', 'pointer-events-none'); }
function saveName() { const val = document.getElementById('input-name').value.trim(); if(val) { userName = val; localStorage.setItem("apan_user_name", val); updateNameDisplay(); closeNameModal(); } }
function updateNameDisplay() { document.getElementById('display-name').innerText = userName; }
function closeAuthModal() { document.getElementById('modal-auth').classList.add('opacity-0', 'pointer-events-none'); }
function closeMenuModal() { document.getElementById('modal-menu-edit').classList.add('opacity-0', 'pointer-events-none'); }

async function submitOrder() {
    if(!userName) { alert("è«‹å…ˆè¨­å®šå§“å"); toggleCart(); openNameModal(); return; }
    if(!cart.length) return alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
    const btn = document.getElementById('btn-submit');
    btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";
    const res = await callApi({ action: "submitOrder", name: userName, items: cart });
    if(res.ok) { alert("è¨‚å–®å·²é€å‡º"); cart = []; updateCartUI(); toggleCart(); fetchMenu(); } else alert(res.message);
    btn.disabled = false; btn.innerText = "é€å‡ºè¨‚å–®";
}

// --- å¾Œå°é‚è¼¯ ---
async function loadAdminOrders() {
    document.getElementById('admin-status').innerText = "æ›´æ–°ä¸­...";
    const res = await callApi({ action: "getPendingOrdersMerged" });
    if(res.ok) {
        const list = res.data;
        document.getElementById('admin-status').innerText = list.length ? `å¾…è™•ç†: ${list.length}` : "ç›®å‰ç„¡è¨‚å–®";
        document.getElementById('admin-orders-container').innerHTML = list.map(t => {
            const isServed = t.status === 'served';
            const btn = isServed 
                ? `<button onclick="reqAuth('clearOrder', '${t.name}')" class="bg-gray-800 text-white px-3 py-1 rounded text-sm">çµå¸³é©—è­‰</button>`
                : `<button onclick="markStatus('${t.name}', 'served')" class="bg-green-500 text-white px-3 py-1 rounded text-sm">å–è²¨</button>`;
            return `<div class="border rounded-xl p-4 shadow-sm ${isServed?'bg-green-50':'bg-white'}"><div class="flex justify-between mb-2"><div><h3 class="font-bold text-lg">${t.name}</h3><span class="text-xs text-gray-500">${formatDateTime(t.time)}</span></div><div>${btn}</div></div><div class="bg-white/60 p-2 rounded mb-2">${t.items.map(i => `<div class="flex justify-between text-sm"><span>${i.item} x${i.qty}</span><span class="font-bold">$${i.subtotal}</span></div>`).join('')}</div><div class="flex justify-end items-center border-t pt-2 font-black text-red-600 text-lg">$${t.total}</div></div>`;
        }).join('') || '<div class="col-span-full text-center py-10 text-gray-300">ç„¡è¨‚å–®</div>';
    }
}

async function markStatus(table, status, pwd="") {
    const res = await callApi({ action: "markTableStatus", table, status, password: pwd });
    if(res.ok) loadAdminOrders(); else alert(res.message);
}

async function loadHistoryData() {
    const tbody = document.getElementById('history-tbody');
    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-10">è®€å–ä¸­...</td></tr>';
    const res = await callApi({ action: "getOrderHistory" });
    if(res.ok) {
        historyData = res.data;
        initHistoryFilters();
        applyHistoryFilters();
    }
}

function initHistoryFilters() {
    const dateSet = new Set(), itemSet = new Set(), nameSet = new Set();
    historyData.forEach(r => {
        if(r.time) { const d = new Date(r.time); dateSet.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`); }
        itemSet.add(r.item); nameSet.add(r.name);
    });
    document.getElementById('hist-filter-date').innerHTML = '<option value="all">æ‰€æœ‰æ—¥æœŸ</option>' + [...dateSet].sort().reverse().map(d => `<option value="${d}">${d}</option>`).join('');
    document.getElementById('hist-filter-item').innerHTML = '<option value="all">æ‰€æœ‰å“é …</option>' + [...itemSet].sort().map(i => `<option value="${i}">${i}</option>`).join('');
    document.getElementById('hist-filter-name').innerHTML = '<option value="all">æ‰€æœ‰äººå“¡</option>' + [...nameSet].sort().map(n => `<option value="${n}">${n}</option>`).join('');
}

function applyHistoryFilters() {
    const dv = document.getElementById('hist-filter-date').value, iv = document.getElementById('hist-filter-item').value, nv = document.getElementById('hist-filter-name').value;
    let tQty = 0, tAmt = 0;
    const filtered = historyData.filter(r => {
        const d = new Date(r.time), ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        return (dv==='all'||ds===dv) && (iv==='all'||r.item===iv) && (nv==='all'||r.name===nv);
    });
    document.getElementById('history-tbody').innerHTML = filtered.map(r => {
        tQty += r.qty; tAmt += r.subtotal;
        return `<tr class="hover:bg-gray-50"><td class="px-4 py-3">${formatDateTime(r.time)}</td><td class="px-4 py-3 font-medium">${r.name}</td><td class="px-4 py-3">${r.item}</td><td class="px-4 py-3 text-right">$${r.price}</td><td class="px-4 py-3 text-center">${r.qty}</td><td class="px-4 py-3 text-right font-bold">$${r.subtotal}</td><td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded-full text-xs ${r.status==='served'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${r.status==='served'?'å·²å–è²¨':'å¾…è™•ç†'}</span></td><td class="px-4 py-3 text-center"><button onclick="reqAuth('deleteRow', ${r.row})" class="text-red-500"><i class="fas fa-trash-alt"></i></button></td></tr>`;
    }).join('');
    document.getElementById('hist-total-qty').innerText = tQty;
    document.getElementById('hist-total-amt').innerText = `$${tAmt}`;
}

function resetHistoryFilters() { document.getElementById('hist-filter-date').value = 'all'; document.getElementById('hist-filter-item').value = 'all'; document.getElementById('hist-filter-name').value = 'all'; applyHistoryFilters(); }

function reqAuth(action, target) {
    const modal = document.getElementById('modal-auth');
    const input = document.getElementById('input-auth-pwd');
    const confirmBtn = document.getElementById('btn-auth-confirm');
    input.value = "";
    modal.classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('auth-title').innerText = action === 'clearOrder' ? "çµå¸³ç¢ºèª" : "å®‰å…¨é©—è­‰";

    confirmBtn.onclick = async () => {
        const pwd = input.value;
        if(!pwd) return;
        confirmBtn.disabled = true;
        let res;
        if(action === 'clearOrder') res = await callApi({ action: "markTableStatus", table: target, status: "cleared", password: pwd });
        else if(action === 'deleteRow') res = await callApi({ action: "deleteOrder", row: target, password: pwd });
        else if(action === 'deleteAll') res = await callApi({ action: "deleteAllOrders", password: pwd });

        if(res && res.ok) { closeAuthModal(); if(action === 'clearOrder') loadAdminOrders(); else loadHistoryData(); } else alert(res ? res.message : "å¤±æ•—");
        confirmBtn.disabled = false;
    };
}

function triggerDeleteAllOrders() { reqAuth('deleteAll', null); }

async function loadAdminMenu() {
    const res = await callApi({ action: "getMenu" });
    if(res.ok) {
        document.getElementById('admin-menu-tbody').innerHTML = res.data.map(i => {
            const imgEl = i.image ? `<img src="${i.image}" class="w-10 h-10 object-cover rounded bg-gray-100">` : `<div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center text-gray-300 text-xs"><i class="fas fa-image"></i></div>`;
            return `<tr class="hover:bg-gray-50">
                <td class="px-4 py-3">${imgEl}</td>
                <td class="px-4 py-3">${i.category}</td>
                <td class="px-4 py-3 font-bold">${i.name}</td>
                <td class="px-4 py-3 hidden md:table-cell text-gray-500 truncate max-w-xs">${i.desc}</td>
                <td class="px-4 py-3 text-red-600 font-bold">$${i.price}</td>
                <td class="px-4 py-3 text-center">
                    <button onclick='openMenuModal("edit", ${JSON.stringify(i).replace(/'/g, "&apos;")})' class="text-blue-500 mr-3"><i class="fas fa-edit"></i></button>
                    <button onclick="triggerMenuDelete(${i.row})" class="text-red-400"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');
    }
}

// === æ–°å¢ï¼šåœ–ç‰‡é¸æ“‡èˆ‡å£“ç¸®é‚è¼¯ ===
function handleFileSelect(input) {
    const preview = document.getElementById('menu-img-preview');
    const placeholder = document.getElementById('menu-img-placeholder');
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        // é è¦½
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
        }
        reader.readAsDataURL(file);

        // åŸ·è¡Œå£“ç¸® (åœ¨èƒŒæ™¯åŸ·è¡Œï¼Œä¸é˜»å¡ UI)
        compressImage(file, 800, 0.7).then(compressedBase64 => {
            pendingImageBase64 = compressedBase64; // å­˜å…¥å…¨åŸŸè®Šæ•¸ç­‰å¾…ä¸Šå‚³
            console.log("Image compressed. Ready to upload.");
        }).catch(err => {
            console.error("Compression failed", err);
            alert("åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹æ›ä¸€å¼µ");
        });
    }
}

// åœ–ç‰‡å£“ç¸®å‡½å¼ (ä½¿ç”¨ Canvas)
function compressImage(file, maxWidth, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = event => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                let width = img.width;
                let height = img.height;
                
                // è¨ˆç®—ç­‰æ¯”ä¾‹ç¸®å°
                if (width > maxWidth) {
                    height = Math.round(height * (maxWidth / width));
                    width = maxWidth;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // è¼¸å‡ºç‚º image/jpeg (å› ç‚º jpeg å£“ç¸®æ•ˆæœæœ€å¥½)
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = error => reject(error);
        };
        reader.onerror = error => reject(error);
    });
}

function openMenuModal(mode, data=null) {
    document.getElementById('modal-menu-edit').classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('menu-modal-title').innerText = mode==='add'?'æ–°å¢å“é …':'ç·¨è¼¯å“é …';
    document.getElementById('menu-row-id').value = data ? data.row : '';
    document.getElementById('menu-cat').value = data ? data.category : '';
    document.getElementById('menu-name').value = data ? data.name : '';
    document.getElementById('menu-price').value = data ? data.price : '';
    document.getElementById('menu-desc').value = data ? data.desc : '';
    
    // åœ–ç‰‡é è¦½é‡ç½®
    const imgUrl = data ? data.image : '';
    document.getElementById('menu-current-img').value = imgUrl;
    document.getElementById('menu-img-input').value = ""; 
    pendingImageBase64 = null; // æ¸…ç©ºå¾…ä¸Šå‚³åœ–ç‰‡
    
    const preview = document.getElementById('menu-img-preview');
    const placeholder = document.getElementById('menu-img-placeholder');
    if(imgUrl) {
        preview.src = imgUrl;
        preview.classList.remove('hidden');
        placeholder.classList.add('hidden');
    } else {
        preview.src = "";
        preview.classList.add('hidden');
        placeholder.classList.remove('hidden');
    }
}

function triggerMenuSave() {
    const row = document.getElementById('menu-row-id').value;
    const saveBtn = document.getElementById('btn-menu-save');
    
    // æº–å‚™ payload
    const payload = { 
        category: document.getElementById('menu-cat').value, 
        name: document.getElementById('menu-name').value, 
        price: document.getElementById('menu-price').value, 
        desc: document.getElementById('menu-desc').value,
        image_current: document.getElementById('menu-current-img').value
    };

    // æª¢æŸ¥æ˜¯å¦æœ‰æ–°åœ–ç‰‡å¾…ä¸Šå‚³
    if (pendingImageBase64) {
        payload.image_data = pendingImageBase64;
    }

    const modal = document.getElementById('modal-auth');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    
    document.getElementById('btn-auth-confirm').onclick = async () => {
        const pwd = document.getElementById('input-auth-pwd').value;
        if(!pwd) return;
        
        saveBtn.innerText = "ä¸Šå‚³ä¸­...";
        saveBtn.disabled = true;
        closeAuthModal();
        
        await sendMenuData(row, payload, pwd);
    };
}

async function sendMenuData(row, payload, password) {
    const res = await callApi({ action: "saveMenuItem", row, ...payload, password });
    const saveBtn = document.getElementById('btn-menu-save');
    saveBtn.innerText = "ä¸‹ä¸€æ­¥";
    saveBtn.disabled = false;
    
    if(res.ok) { 
        closeMenuModal(); 
        loadAdminMenu(); 
        fetchMenu(); 
        alert("å„²å­˜æˆåŠŸï¼");
    } else {
        alert(res.message);
    }
}

function triggerMenuDelete(row) {
    const modal = document.getElementById('modal-auth');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('btn-auth-confirm').onclick = async () => {
        const res = await callApi({ action: "deleteMenuItem", row, password: document.getElementById('input-auth-pwd').value });
        if(res.ok) { closeAuthModal(); loadAdminMenu(); fetchMenu(); } else alert(res.message);
    };
}

function formatDateTime(isoStr) {
    if(!isoStr) return "--/--";
    const d = new Date(isoStr);
    return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}
</script>
</body>
</html>
