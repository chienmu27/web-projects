<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é˜¿èƒ–åœ˜è³¼ç³»çµ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
  body { font-family: 'Noto Sans TC', sans-serif; background-color: #f9fafb; -webkit-tap-highlight-color: transparent; }
  .category-btn.active { background-color: #ef4444; color: white; border-color: #ef4444; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .modal { transition: opacity 0.25s ease; }
  body.modal-active { overflow: hidden; }
</style>
</head>
<body class="pb-20 text-gray-800">

<header class="bg-red-600 text-white shadow-md sticky top-0 z-40">
  <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
    <h1 class="text-2xl font-bold flex items-center gap-2 shrink-0">
        <i class="fas fa-utensils"></i> é˜¿èƒ–åœ˜è³¼
    </h1>
    <div class="flex items-center gap-4 flex-1 justify-center w-full md:w-auto">
        <div class="bg-red-800 p-1.5 rounded-xl flex text-base font-bold shadow-inner">
            <button onclick="switchView('client')" id="btn-view-client" class="px-5 py-2 rounded-lg bg-white text-red-800 shadow transition whitespace-nowrap">è¨‚è³¼å•†å“</button>
            <button onclick="switchView('admin')" id="btn-view-admin" class="px-5 py-2 rounded-lg text-red-200 hover:text-white transition whitespace-nowrap">è¨‚è³¼æŸ¥è©¢</button>
        </div>
        <div onclick="toggleCart()" class="flex items-center gap-3 cursor-pointer bg-red-700 hover:bg-red-800 px-5 py-2 rounded-full transition shadow-lg border border-red-500">
            <span class="text-lg font-bold whitespace-nowrap">æª¢æŸ¥è³¼ç‰©è»Š</span>
            <div class="relative">
                <i class="fas fa-shopping-cart text-2xl"></i>
                <span id="header-cart-count" class="absolute -top-2 -right-3 bg-yellow-400 text-red-800 text-xs font-black px-2 py-0.5 rounded-full border-2 border-red-600">0</span>
            </div>
        </div>
    </div>
    <div class="hidden md:block w-32"></div>
  </div>
</header>

<div id="view-client">
    <div class="bg-orange-50 border-b border-orange-100 p-4">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
            <div class="w-full md:w-2/3 overflow-hidden">
                <marquee id="marquee-text" class="text-xl text-gray-700 font-bold bg-transparent py-1 px-2" scrollamount="6">
                    è¼‰å…¥ä¸­...
                </marquee>
            </div>
            <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                <button onclick="openNameModal()" class="flex-1 md:flex-none bg-white border border-orange-200 text-orange-700 px-4 py-2 rounded-full shadow-sm hover:bg-orange-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-user-edit"></i> <span id="display-name">è¨­å®šè¨‚è³¼äºº</span>
                </button>
            </div>
        </div>
    </div>

    <nav id="category-nav" class="sticky top-[80px] md:top-[88px] bg-white/95 backdrop-blur border-b overflow-x-auto whitespace-nowrap z-30 px-4 py-3 flex gap-2 no-scrollbar shadow-sm">
        <button onclick="filterMenu('all')" class="category-btn active px-4 py-1.5 rounded-full border border-gray-300 text-sm font-medium transition">å…¨éƒ¨</button>
    </nav>

    <main class="container mx-auto p-4 min-h-[50vh]">
        <div id="loading-spinner" class="text-center py-20 text-gray-400">
            <i class="fas fa-circle-notch fa-spin text-4xl mb-3 text-red-400"></i>
            <p>æ­£åœ¨è¼‰å…¥èœå–®...</p>
        </div>
        <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>
</div>

<div id="view-admin" class="hidden container mx-auto p-4">
    <div class="flex flex-wrap gap-2 md:gap-4 border-b mb-6 overflow-x-auto no-scrollbar">
        <button onclick="switchAdminTab('orders')" id="tab-orders" class="px-4 py-2 font-bold whitespace-nowrap text-red-600 border-b-2 border-red-600">è¨‚å–®ç®¡ç†</button>
        <button onclick="switchAdminTab('history')" id="tab-history" class="px-4 py-2 font-bold whitespace-nowrap text-gray-400 hover:text-gray-600">è¨‚å–®ç¸½è¡¨</button>
        <button onclick="switchAdminTab('menu')" id="tab-menu" class="px-4 py-2 font-bold whitespace-nowrap text-gray-400 hover:text-gray-600">èœå–®ç®¡ç†</button>
    </div>

    <div id="admin-orders-panel">
        <div class="flex justify-between items-center mb-4">
            <p id="admin-status" class="text-sm text-gray-500">è¼‰å…¥ä¸­...</p>
            <button onclick="loadAdminOrders()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded text-sm transition"><i class="fas fa-sync-alt mr-1"></i> åˆ·æ–°</button>
        </div>
        <div id="admin-orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <div id="admin-history-panel" class="hidden">
        <div class="bg-white rounded-xl shadow-sm border p-4 mb-4">
            <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-filter text-red-500"></i> æŸ¥è©¢æ¢ä»¶</h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                <select id="hist-filter-date" class="border rounded-lg px-3 py-2 bg-gray-50 text-sm focus:ring-2 focus:ring-red-500 focus:outline-none" onchange="applyHistoryFilters()">
                    <option value="all">è¼‰å…¥ä¸­...</option>
                </select>
                <select id="hist-filter-item" class="border rounded-lg px-3 py-2 bg-gray-50 text-sm focus:ring-2 focus:ring-red-500 focus:outline-none" onchange="applyHistoryFilters()">
                    <option value="all">æ‰€æœ‰å“é …</option>
                </select>
                <select id="hist-filter-name" class="border rounded-lg px-3 py-2 bg-gray-50 text-sm focus:ring-2 focus:ring-red-500 focus:outline-none" onchange="applyHistoryFilters()">
                    <option value="all">æ‰€æœ‰äººå“¡</option>
                </select>
                <button onclick="resetHistoryFilters()" class="bg-gray-200 text-gray-600 rounded-lg px-3 py-2 text-sm font-bold hover:bg-gray-300 transition">é‡ç½®æ¢ä»¶</button>
                <button onclick="triggerDeleteAllOrders()" class="bg-red-600 text-white rounded-lg px-3 py-2 text-sm font-bold hover:bg-red-700 transition shadow"><i class="fas fa-trash"></i> åˆªé™¤å…¨éƒ¨</button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-700 border-b">
                        <tr>
                            <th class="px-4 py-3 whitespace-nowrap">æ—¥æœŸ</th>
                            <th class="px-4 py-3 whitespace-nowrap">å§“å</th>
                            <th class="px-4 py-3">å“é …</th>
                            <th class="px-4 py-3 text-right">å–®åƒ¹</th>
                            <th class="px-4 py-3 text-center">æ•¸é‡</th>
                            <th class="px-4 py-3 text-right">å°è¨ˆ</th>
                            <th class="px-4 py-3 text-center">ç‹€æ…‹</th>
                            <th class="px-4 py-3 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody" class="divide-y divide-gray-100">
                        <tr><td colspan="8" class="px-4 py-10 text-center text-gray-400">è«‹ç¨å€™ï¼Œæ­£åœ¨è®€å–è³‡æ–™...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="bg-red-50 border-t border-red-100 p-4 flex flex-col md:flex-row justify-end items-center gap-4 text-red-800">
                <div class="font-bold">ç¸½æ•¸é‡ï¼š<span id="hist-total-qty" class="text-xl ml-1">0</span></div>
                <div class="font-bold">ç¸½é‡‘é¡ï¼š<span id="hist-total-amt" class="text-xl ml-1">$0</span></div>
            </div>
        </div>
    </div>

    <div id="admin-menu-panel" class="hidden">
        <div class="flex justify-between items-center mb-4">
            <p class="text-sm text-gray-500">ç®¡ç†ç¾æœ‰èœå–® (ä¿®æ”¹å¾Œéœ€åˆ·æ–°)</p>
            <div class="flex gap-2">
                <button onclick="loadAdminMenu()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded text-sm transition flex items-center gap-1">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°
                </button>
                <button onclick="openMenuModal('add')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm font-bold shadow transition"><i class="fas fa-plus mr-1"></i> æ–°å¢å“é …</button>
            </div>
        </div>
        <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-700 border-b">
                    <tr>
                        <th class="px-4 py-3">é¡åˆ¥</th>
                        <th class="px-4 py-3">åç¨±</th>
                        <th class="px-4 py-3 hidden md:table-cell">æè¿°</th>
                        <th class="px-4 py-3">åƒ¹æ ¼</th>
                        <th class="px-4 py-3 text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="admin-menu-tbody" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="cart-sidebar" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[60] flex flex-col">
  <div class="p-4 border-b flex justify-between items-center bg-gray-50">
    <h3 class="font-bold text-lg"><i class="fas fa-shopping-bag text-red-500 mr-2"></i>å·²é¸é¤é»</h3>
    <button onclick="toggleCart()" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition">&times;</button>
  </div>
  <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-3"></div>
  <div class="p-4 border-t bg-gray-50 safe-area-bottom">
    <div class="flex justify-between mb-4 items-end">
        <span class="text-gray-600 text-sm">ç¸½è¨ˆ</span>
        <span class="text-red-600 font-black text-2xl" id="total-price">$0</span>
    </div>
    <button id="btn-submit" onclick="submitOrder()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3.5 rounded-xl font-bold shadow-lg transition">é€å‡ºè¨‚å–®</button>
  </div>
</div>
<div id="overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/40 backdrop-blur-[1px] hidden z-50 transition-opacity"></div>

<div id="modal-name" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70]">
    <div class="modal-overlay absolute w-full h-full bg-black/50 backdrop-blur-sm" onclick="closeNameModal()"></div>
    <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 p-6 transform scale-95 transition-transform duration-300">
        <h3 class="text-xl font-bold mb-2">ğŸ‘‹ è¨­å®šè¨‚è³¼äºº</h3>
        <p class="text-gray-500 text-sm mb-4">è«‹åœ¨æ­¤è¼¸å…¥å§“åï¼Œæ–¹ä¾¿ç™¼é¤è¾¨è­˜</p>
        <input id="input-name" type="text" class="w-full bg-gray-50 text-lg border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-red-500 focus:outline-none mb-4" placeholder="ä¾‹å¦‚ï¼šè¨­è¨ˆéƒ¨ å°æ˜">
        <button onclick="saveName()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl shadow hover:bg-red-700">ç¢ºå®š</button>
    </div>
</div>

<div id="modal-auth" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[80]">
    <div class="modal-overlay absolute w-full h-full bg-black/60" onclick="closeAuthModal()"></div>
    <div class="modal-container bg-white w-11/12 md:max-w-sm mx-auto rounded-2xl shadow-2xl z-50 p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-2" id="auth-title">é©—è­‰èº«åˆ†</h3>
        <p class="text-gray-500 text-sm mb-4" id="auth-desc">è«‹è¼¸å…¥é©—è­‰ç¢¼</p>
        <input id="input-auth-pwd" type="password" inputmode="numeric" class="w-full text-center tracking-widest text-2xl border rounded-xl px-4 py-2 mb-4 focus:ring-2 focus:ring-red-500 focus:outline-none" placeholder="â—â—â—â—">
        <div class="flex gap-3">
            <button onclick="closeAuthModal()" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
            <button id="btn-auth-confirm" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold shadow">ç¢ºèª</button>
        </div>
    </div>
</div>

<div id="modal-menu-edit" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70]">
    <div class="modal-overlay absolute w-full h-full bg-black/50 backdrop-blur-sm" onclick="closeMenuModal()"></div>
    <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 p-6 overflow-y-auto max-h-[90vh]">
        <h3 class="text-xl font-bold mb-4" id="menu-modal-title">ç·¨è¼¯å“é …</h3>
        <input type="hidden" id="menu-row-id">
        <div class="space-y-3">
            <div><label class="text-xs font-bold text-gray-500">åˆ†é¡</label><input id="menu-cat" type="text" class="w-full border rounded-lg px-3 py-2 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:outline-none"></div>
            <div><label class="text-xs font-bold text-gray-500">åç¨±</label><input id="menu-name" type="text" class="w-full border rounded-lg px-3 py-2 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:outline-none"></div>
            <div><label class="text-xs font-bold text-gray-500">åƒ¹æ ¼</label><input id="menu-price" type="number" class="w-full border rounded-lg px-3 py-2 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:outline-none"></div>
            <div><label class="text-xs font-bold text-gray-500">æè¿°</label><textarea id="menu-desc" rows="2" class="w-full border rounded-lg px-3 py-2 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-500 focus:outline-none"></textarea></div>
        </div>
        <div class="mt-6 flex gap-3">
            <button onclick="closeMenuModal()" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
            <button onclick="triggerMenuSave()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold shadow">ä¸‹ä¸€æ­¥ (é©—è­‰)</button>
        </div>
    </div>
</div>

<script>
// ================= è¨­å®šå€ =================
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwW4SpBk1mboxHkQ2-meirj0VwyEkCVtzKpLiMXgQt8uaEeG4KMMGr5StKRNJnSD1YM/exec"; 

// ================= å…¨åŸŸè®Šæ•¸ =================
let menuData = [];
let cart = [];
let historyData = [];
let userName = localStorage.getItem("apan_user_name") || "";
let currentView = "client";
let authCallback = null;
let currentCategory = 'all';

// ================= åˆå§‹åŒ– =================
window.onload = () => {
    if(userName) updateNameDisplay();
    fetchMenu();
};

async function callApi(payload) {
    try {
        const res = await fetch(GAS_API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload)
        });
        return await res.json();
    } catch (e) {
        return { ok: false, message: "ç¶²è·¯éŒ¯èª¤" };
    }
}

// ================= è¦–åœ–åˆ‡æ› =================
function switchView(view) {
    currentView = view;
    document.getElementById('view-client').classList.toggle('hidden', view !== 'client');
    document.getElementById('view-admin').classList.toggle('hidden', view !== 'admin');
    
    const btnClient = document.getElementById('btn-view-client');
    const btnAdmin = document.getElementById('btn-view-admin');
    if(view === 'client') {
        btnClient.className = "px-5 py-2 rounded-lg bg-white text-red-800 shadow transition whitespace-nowrap";
        btnAdmin.className = "px-5 py-2 rounded-lg text-red-200 hover:text-white transition whitespace-nowrap";
    } else {
        btnClient.className = "px-5 py-2 rounded-lg text-red-200 hover:text-white transition whitespace-nowrap";
        btnAdmin.className = "px-5 py-2 rounded-lg bg-white text-red-800 shadow transition whitespace-nowrap";
        loadAdminOrders();
    }
}

function switchAdminTab(tab) {
    ['orders', 'history', 'menu'].forEach(t => {
        const btn = document.getElementById(`tab-${t}`);
        const isActive = t === tab;
        btn.className = `px-4 py-2 font-bold whitespace-nowrap transition ${isActive ? 'text-red-600 border-b-2 border-red-600' : 'text-gray-400 hover:text-gray-600'}`;
        document.getElementById(`admin-${t}-panel`).classList.toggle('hidden', !isActive);
    });
    
    if(tab === 'orders') loadAdminOrders();
    if(tab === 'history') loadHistoryData();
    if(tab === 'menu') loadAdminMenu();
}

// ================= å‰å°åŠŸèƒ½ =================
async function fetchMenu() {
    const res = await callApi({ action: "getMenu" });
    if (res.ok) {
        menuData = res.data;
        if(res.marquee) document.getElementById('marquee-text').innerText = res.marquee;
        renderClientMenu();
        document.getElementById('loading-spinner').style.display = 'none';
    }
}

function renderClientMenu() {
    const nav = document.getElementById('category-nav');
    const validItems = menuData.filter(i => i.name && i.name.trim() !== "");
    const cats = ['all', ...new Set(validItems.map(i => i.category))];
    nav.innerHTML = cats.map(c => `
        <button onclick="filterMenu('${c}')" class="category-btn ${c==='all'?'active':''} px-4 py-1.5 rounded-full border border-gray-300 text-sm transition text-gray-600">
            ${c==='all'?'å…¨éƒ¨':c}
        </button>
    `).join('');
    displayMenu(validItems);
}

function filterMenu(c) {
    currentCategory = c;
    document.querySelectorAll('.category-btn').forEach(b => {
        const txt = (b.innerText === 'å…¨éƒ¨') ? 'all' : b.innerText;
        b.className = `category-btn px-4 py-1.5 rounded-full border text-sm transition ${txt === c ? 'active border-red-500' : 'border-gray-300 text-gray-600'}`;
    });
    const validItems = menuData.filter(i => i.name && i.name.trim() !== "");
    const items = (c === 'all') ? validItems : validItems.filter(i => i.category === c);
    displayMenu(items);
}

function displayMenu(items) {
    const container = document.getElementById('menu-container');
    if(items.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-10">ç„¡ç›¸é—œé¤é»</div>';
        return;
    }
    container.innerHTML = items.map(i => {
        const inCart = cart.find(c => c.row === i.row);
        const qty = inCart ? inCart.qty : 0;
        let btnHtml = (qty === 0) 
            ? `<button onclick="addToCart(${i.row})" class="bg-red-50 text-red-600 font-bold px-4 py-2 rounded-full hover:bg-red-100 transition shadow-sm w-full">åŠ å…¥</button>`
            : `<div class="flex items-center justify-between bg-red-600 text-white rounded-full w-full px-1 py-1 shadow-md">
                <button onclick="updateItemQty(${i.row}, -1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/30 active:scale-90 transition"><i class="fas fa-minus text-xs"></i></button>
                <span class="font-bold text-lg">${qty}</span>
                <button onclick="updateItemQty(${i.row}, 1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/30 active:scale-90 transition"><i class="fas fa-plus text-xs"></i></button>
               </div>`;

        return `<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex flex-col justify-between hover:shadow-md transition">
            <div>
                <span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-bold">${i.category}</span>
                <h3 class="font-bold text-lg mt-1">${i.name}</h3>
                <p class="text-xs text-gray-400 mt-1 line-clamp-2">${i.desc}</p>
            </div>
            <div class="flex justify-between items-end mt-3 gap-3">
                <p class="text-red-600 font-black text-lg">$${i.price}</p>
                <div class="w-28 flex justify-end" id="btn-container-${i.row}">${btnHtml}</div>
            </div>
        </div>`;
    }).join('');
}

function addToCart(rowId) {
    const item = menuData.find(m => m.row === rowId);
    if(!item) return;
    cart.push({...item, qty:1});
    updateCartUI();
    refreshMenuCardUI(rowId);
}

function updateItemQty(rowId, delta) {
    const idx = cart.findIndex(c => c.row === rowId);
    if (idx !== -1) {
        cart[idx].qty += delta;
        if (cart[idx].qty <= 0) cart.splice(idx, 1);
    } else if (delta > 0) {
        addToCart(rowId);
        return;
    }
    updateCartUI();
    refreshMenuCardUI(rowId);
}

function refreshMenuCardUI(rowId) {
    const container = document.getElementById(`btn-container-${rowId}`);
    if (!container) return;
    const inCart = cart.find(c => c.row === rowId);
    const qty = inCart ? inCart.qty : 0;
    container.innerHTML = (qty === 0)
        ? `<button onclick="addToCart(${rowId})" class="bg-red-50 text-red-600 font-bold px-4 py-2 rounded-full hover:bg-red-100 transition shadow-sm w-full">åŠ å…¥</button>`
        : `<div class="flex items-center justify-between bg-red-600 text-white rounded-full w-full px-1 py-1 shadow-md">
            <button onclick="updateItemQty(${rowId}, -1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/30 active:scale-90 transition"><i class="fas fa-minus text-xs"></i></button>
            <span class="font-bold text-lg">${qty}</span>
            <button onclick="updateItemQty(${rowId}, 1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/30 active:scale-90 transition"><i class="fas fa-plus text-xs"></i></button>
           </div>`;
}

function updateCartUI() {
    const list = document.getElementById('cart-items');
    let total = 0, count = 0;
    list.innerHTML = cart.length ? '' : '<div class="text-center text-gray-400 py-10">è³¼ç‰©è»Šç©ºçš„</div>';
    cart.forEach((c) => {
        total += c.price * c.qty; count += c.qty;
        list.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl mb-2">
            <div class="flex-1"><div class="font-bold">${c.name}</div><div class="text-xs text-gray-500">$${c.price}</div></div>
            <div class="flex items-center gap-2 bg-white px-2 py-1 rounded border">
                <button onclick="updateItemQty(${c.row},-1)" class="w-5 text-gray-400 hover:text-red-600"><i class="fas fa-minus text-xs"></i></button>
                <span class="font-bold text-sm w-4 text-center">${c.qty}</span>
                <button onclick="updateItemQty(${c.row},1)" class="w-5 text-gray-400 hover:text-green-600"><i class="fas fa-plus text-xs"></i></button>
            </div>
            <div class="w-12 text-right font-bold text-gray-700">$${c.price*c.qty}</div>
        </div>`;
    });
    document.getElementById('header-cart-count').innerText = count;
    document.getElementById('total-price').innerText = `$${total}`;
}

function toggleCart() {
    document.getElementById('cart-sidebar').classList.toggle('translate-x-full');
    document.getElementById('overlay').classList.toggle('hidden');
    document.body.classList.toggle('modal-active');
}

function openNameModal() { document.getElementById('modal-name').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('input-name').value = userName; }
function closeNameModal() { document.getElementById('modal-name').classList.add('opacity-0', 'pointer-events-none'); }
function saveName() { const val = document.getElementById('input-name').value.trim(); if(val) { userName = val; localStorage.setItem("apan_user_name", val); updateNameDisplay(); closeNameModal(); } }
function updateNameDisplay() { document.getElementById('display-name').innerText = userName; }

async function submitOrder() {
    if(!userName) { alert("è«‹å…ˆè¨­å®šå§“å"); toggleCart(); openNameModal(); return; }
    if(!cart.length) return alert("è³¼ç‰©è»Šç©ºçš„");
    const btn = document.getElementById('btn-submit');
    btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";
    const res = await callApi({ action: "submitOrder", name: userName, items: cart });
    if(res.ok) { alert("è¨‚å–®å·²é€å‡º"); cart = []; updateCartUI(); toggleCart(); fetchMenu(); } else { alert("å¤±æ•—: " + res.message); }
    btn.disabled = false; btn.innerText = "é€å‡ºè¨‚å–®";
}

// ================= å¾Œå° - è¨‚å–®ç®¡ç† =================
async function loadAdminOrders() {
    document.getElementById('admin-status').innerText = "æ›´æ–°ä¸­...";
    const res = await callApi({ action: "getPendingOrdersMerged" });
    const container = document.getElementById('admin-orders-container');
    container.innerHTML = '';
    if(res.ok) {
        const list = res.data;
        document.getElementById('admin-status').innerText = list.length ? `å¾…è™•ç†: ${list.length}` : "ç›®å‰ç„¡è¨‚å–®";
        if(!list.length) container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-300"><p>ç„¡å¾…è™•ç†è¨‚å–®</p></div>`;
        list.forEach(t => {
            const isServed = t.status === 'served';
            const htmlItems = t.items.map(i => `<div class="flex justify-between border-b last:border-0 border-gray-100 py-1 text-sm"><span>${i.item} x${i.qty}</span><span class="font-bold text-gray-600">$${i.subtotal}</span></div>`).join('');
            // ä¿®æ”¹ï¼šå–è²¨ä¸é©—è­‰ï¼Œçµå¸³(æ¸…é™¤)éœ€é©—è­‰
            const btn = isServed 
                ? `<button onclick="reqAuth('clearOrder', '${t.name}')" class="bg-gray-800 text-white px-3 py-1 rounded text-sm hover:bg-gray-900">çµå¸³ (éœ€é©—è­‰)</button>`
                : `<button onclick="markStatus('${t.name}', 'served')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">å–è²¨</button>`;
            
            container.innerHTML += `<div class="border rounded-xl p-4 shadow-sm ${isServed?'bg-green-50 border-green-200':'bg-white'}">
                <div class="flex justify-between mb-2">
                    <div><h3 class="font-bold text-lg">${t.name}</h3><span class="text-xs text-gray-500">${formatDateTime(t.time)}</span></div>
                    <div>${btn}</div>
                </div>
                <div class="bg-white/60 p-2 rounded mb-2 space-y-1">${htmlItems}</div>
                <div class="flex justify-end items-center border-t pt-2 border-gray-200/50">
                    <span class="text-gray-500 text-xs mr-2 font-bold">ç¸½é‡‘é¡</span><div class="font-black text-red-600 text-lg">$${t.total}</div>
                </div>
            </div>`;
        });
    }
}

async function markStatus(table, status, pwd="") {
    const res = await callApi({ action: "markTableStatus", table, status, password: pwd });
    if(res.ok) loadAdminOrders(); else alert(res.message);
}

// ================= å¾Œå° - è¨‚å–®ç¸½è¡¨ =================
async function loadHistoryData() {
    const tbody = document.getElementById('history-tbody');
    tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-10 text-center text-gray-400">è³‡æ–™è®€å–ä¸­...</td></tr>';
    const res = await callApi({ action: "getOrderHistory" });
    if(res.ok) {
        historyData = res.data;
        initHistoryFilters();
        applyHistoryFilters();
    }
}

function initHistoryFilters() {
    const dateSet = new Set(), itemSet = new Set(), nameSet = new Set();
    historyData.forEach(r => {
        try { const d = new Date(r.time); dateSet.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`); } catch(e){}
        itemSet.add(r.item); nameSet.add(r.name);
    });
    document.getElementById('hist-filter-date').innerHTML = '<option value="all">æ‰€æœ‰æ—¥æœŸ</option>' + [...dateSet].sort().reverse().map(d => `<option value="${d}">${d}</option>`).join('');
    document.getElementById('hist-filter-item').innerHTML = '<option value="all">æ‰€æœ‰å“é …</option>' + [...itemSet].sort().map(i => `<option value="${i}">${i}</option>`).join('');
    document.getElementById('hist-filter-name').innerHTML = '<option value="all">æ‰€æœ‰äººå“¡</option>' + [...nameSet].sort().map(n => `<option value="${n}">${n}</option>`).join('');
}

function applyHistoryFilters() {
    const dv = document.getElementById('hist-filter-date').value, iv = document.getElementById('hist-filter-item').value, nv = document.getElementById('hist-filter-name').value;
    const tbody = document.getElementById('history-tbody');
    let tQty = 0, tAmt = 0;
    const filtered = historyData.filter(r => {
        const d = new Date(r.time), ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        return (dv==='all'||ds===dv) && (iv==='all'||r.item===iv) && (nv==='all'||r.name===nv);
    });
    tbody.innerHTML = filtered.map(r => {
        tQty += r.qty; tAmt += r.subtotal;
        return `<tr class="hover:bg-gray-50">
            <td class="px-4 py-3">${formatDateTime(r.time)}</td>
            <td class="px-4 py-3 font-medium">${r.name}</td>
            <td class="px-4 py-3">${r.item}</td>
            <td class="px-4 py-3 text-right">$${r.price}</td>
            <td class="px-4 py-3 text-center">${r.qty}</td>
            <td class="px-4 py-3 text-right font-bold">$${r.subtotal}</td>
            <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded-full text-xs ${r.status==='served'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${r.status==='served'?'å·²å–è²¨':'å¾…è™•ç†'}</span></td>
            <td class="px-4 py-3 text-center">
                <button onclick="reqAuth('deleteRow', ${r.row})" class="text-red-500 hover:text-red-700 transition"><i class="fas fa-trash-alt"></i></button>
            </td>
        </tr>`;
    }).join('');
    document.getElementById('hist-total-qty').innerText = tQty;
    document.getElementById('hist-total-amt').innerText = `$${tAmt}`;
}

function resetHistoryFilters() {
    document.getElementById('hist-filter-date').value = 'all';
    document.getElementById('hist-filter-item').value = 'all';
    document.getElementById('hist-filter-name').value = 'all';
    applyHistoryFilters();
}

// ================= é©—è­‰èˆ‡åˆªé™¤é‚è¼¯ =================
function reqAuth(action, target) {
    const modal = document.getElementById('modal-auth');
    const input = document.getElementById('input-auth-pwd');
    const confirmBtn = document.getElementById('btn-auth-confirm');
    input.value = "";
    modal.classList.remove('opacity-0', 'pointer-events-none');
    
    if(action === 'clearOrder') {
        document.getElementById('auth-title').innerText = "çµå¸³ç¢ºèª";
        document.getElementById('auth-desc').innerText = `è«‹è¼¸å…¥é©—è­‰ç¢¼ä»¥å°‡ã€Œ${target}ã€è¨­ç‚ºçµå¸³å®Œæˆ`;
    } else if(action === 'deleteRow') {
        document.getElementById('auth-title').innerText = "åˆªé™¤è¨‚å–®";
        document.getElementById('auth-desc').innerText = "è«‹è¼¸å…¥é©—è­‰ç¢¼ä»¥åˆªé™¤æ­¤ç­†è³‡æ–™";
    } else if(action === 'deleteAll') {
        document.getElementById('auth-title').innerText = "å±éšªæ“ä½œ";
        document.getElementById('auth-desc').innerText = "è«‹è¼¸å…¥é©—è­‰ç¢¼ä»¥åˆªé™¤ã€Œæ‰€æœ‰ã€è¨‚å–®ç´€éŒ„";
    }

    confirmBtn.onclick = async () => {
        const pwd = input.value;
        if(!pwd) return;
        confirmBtn.disabled = true; confirmBtn.innerText = "è™•ç†ä¸­...";
        
        let res;
        if(action === 'clearOrder') res = await callApi({ action: "markTableStatus", table: target, status: "cleared", password: pwd });
        else if(action === 'deleteRow') res = await callApi({ action: "deleteOrder", row: target, password: pwd });
        else if(action === 'deleteAll') res = await callApi({ action: "deleteAllOrders", password: pwd });

        if(res && res.ok) {
            closeAuthModal();
            if(action === 'clearOrder') loadAdminOrders(); else loadHistoryData();
        } else {
            alert(res ? res.message : "é©—è­‰å¤±æ•—");
        }
        confirmBtn.disabled = false; confirmBtn.innerText = "ç¢ºèª";
    };
}

function closeAuthModal() { document.getElementById('modal-auth').classList.add('opacity-0', 'pointer-events-none'); }
function triggerDeleteAllOrders() { reqAuth('deleteAll', null); }

// ================= èœå–®ç®¡ç† =================
async function loadAdminMenu() {
    const tbody = document.getElementById('admin-menu-tbody');
    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-10 text-center text-gray-400">è®€å–ä¸­...</td></tr>';
    const res = await callApi({ action: "getMenu" });
    if(res.ok) {
        tbody.innerHTML = res.data.map(i => `<tr class="hover:bg-gray-50">
            <td class="px-4 py-3">${i.category}</td>
            <td class="px-4 py-3 font-bold">${i.name}</td>
            <td class="px-4 py-3 hidden md:table-cell text-gray-500">${i.desc}</td>
            <td class="px-4 py-3 text-red-600 font-bold">$${i.price}</td>
            <td class="px-4 py-3 text-center">
                <button onclick="openMenuModal('edit', ${JSON.stringify(i).replace(/"/g, '&quot;')})" class="text-blue-500 hover:text-blue-700 mr-3"><i class="fas fa-edit"></i></button>
                <button onclick="triggerMenuDelete(${i.row})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`).join('');
    }
}

function openMenuModal(mode, data=null) {
    const modal = document.getElementById('modal-menu-edit');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('menu-modal-title').innerText = mode==='add'?'æ–°å¢å“é …':'ç·¨è¼¯å“é …';
    document.getElementById('menu-row-id').value = data ? data.row : '';
    document.getElementById('menu-cat').value = data ? data.category : '';
    document.getElementById('menu-name').value = data ? data.name : '';
    document.getElementById('menu-price').value = data ? data.price : '';
    document.getElementById('menu-desc').value = data ? data.desc : '';
}

function closeMenuModal() { document.getElementById('modal-menu-edit').classList.add('opacity-0', 'pointer-events-none'); }

function triggerMenuSave() {
    const row = document.getElementById('menu-row-id').value;
    const payload = {
        category: document.getElementById('menu-cat').value,
        name: document.getElementById('menu-name').value,
        price: document.getElementById('menu-price').value,
        desc: document.getElementById('menu-desc').value
    };
    const modal = document.getElementById('modal-auth');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('auth-title').innerText = "é¸å–®ç¶­è­·é©—è­‰";
    document.getElementById('btn-auth-confirm').onclick = async () => {
        const pwd = document.getElementById('input-auth-pwd').value;
        const res = await callApi({ action: "saveMenuItem", row, ...payload, password: pwd });
        if(res.ok) { closeAuthModal(); closeMenuModal(); loadAdminMenu(); fetchMenu(); } else alert(res.message);
    };
}

function triggerMenuDelete(row) {
    const modal = document.getElementById('modal-auth');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('auth-title').innerText = "åˆªé™¤å“é …é©—è­‰";
    document.getElementById('btn-auth-confirm').onclick = async () => {
        const pwd = document.getElementById('input-auth-pwd').value;
        const res = await callApi({ action: "deleteMenuItem", row, password: pwd });
        if(res.ok) { closeAuthModal(); loadAdminMenu(); fetchMenu(); } else alert(res.message);
    };
}

function formatDateTime(isoStr) {
    try {
        const d = new Date(isoStr);
        return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    } catch(e) { return "--/-- --:--"; }
}
</script>
</body>
</html>
