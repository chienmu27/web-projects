<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é˜¿èƒ–åœ˜è³¼ç³»çµ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
  body { font-family: 'Noto Sans TC', sans-serif; background-color: #f9fafb; -webkit-tap-highlight-color: transparent; }
  .category-btn.active { background-color: #ef4444; color: white; border-color: #ef4444; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .modal { transition: opacity 0.2s ease; }
  body.modal-active { overflow: hidden; }
</style>
</head>
<body class="pb-20 text-gray-800">

<header class="bg-red-600 text-white shadow-md sticky top-0 z-40">
  <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
    <h1 class="text-2xl font-bold flex items-center gap-2 shrink-0">
        <i class="fas fa-utensils"></i> é˜¿èƒ–åœ˜è³¼
    </h1>
    <div class="flex items-center gap-4 flex-1 justify-center w-full md:w-auto">
        <div class="bg-red-800 p-1.5 rounded-xl flex text-base font-bold shadow-inner">
            <button onclick="switchView('client')" id="btn-view-client" class="px-5 py-2 rounded-lg bg-white text-red-800 shadow transition whitespace-nowrap">è¨‚è³¼å•†å“</button>
            <button onclick="switchView('admin')" id="btn-view-admin" class="px-5 py-2 rounded-lg text-red-200 hover:text-white transition whitespace-nowrap">è¨‚è³¼æŸ¥è©¢</button>
        </div>
        <div onclick="toggleCart()" class="flex items-center gap-3 cursor-pointer bg-red-700 hover:bg-red-800 px-5 py-2 rounded-full transition shadow-lg border border-red-500">
            <span class="text-lg font-bold whitespace-nowrap">è³¼ç‰©è»Š</span>
            <div class="relative">
                <i class="fas fa-shopping-cart text-2xl"></i>
                <span id="header-cart-count" class="absolute -top-2 -right-3 bg-yellow-400 text-red-800 text-xs font-black px-2 py-0.5 rounded-full border-2 border-red-600">0</span>
            </div>
        </div>
    </div>
    <div class="hidden md:block w-32"></div>
  </div>
</header>

<div id="view-client">
    <div class="bg-orange-50 border-b border-orange-100 p-4">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
            <div class="w-full md:w-2/3 overflow-hidden">
                <marquee id="marquee-text" class="text-xl text-gray-700 font-bold bg-transparent py-1 px-2" scrollamount="6">è¼‰å…¥ä¸­...</marquee>
            </div>
            <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                <button onclick="openNameModal()" class="flex-1 md:flex-none bg-white border border-orange-200 text-orange-700 px-4 py-2 rounded-full shadow-sm hover:bg-orange-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-user-edit"></i> <span id="display-name">è¨­å®šè¨‚è³¼äºº</span>
                </button>
            </div>
        </div>
    </div>

    <nav id="category-nav" class="sticky top-[80px] md:top-[88px] bg-white/95 backdrop-blur border-b overflow-x-auto whitespace-nowrap z-30 px-4 py-3 flex gap-2 no-scrollbar shadow-sm"></nav>

    <main class="container mx-auto p-4 min-h-[50vh]">
        <div id="loading-spinner" class="text-center py-20 text-gray-400">
            <i class="fas fa-circle-notch fa-spin text-4xl mb-3 text-red-400"></i>
            <p>æ­£åœ¨åŒæ­¥æœ€æ–°èœå–®...</p>
        </div>
        <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>
</div>

<div id="view-admin" class="hidden container mx-auto p-4">
    <div class="flex flex-wrap gap-2 md:gap-4 border-b mb-6 overflow-x-auto no-scrollbar">
        <button onclick="switchAdminTab('orders')" id="tab-orders" class="px-4 py-2 font-bold whitespace-nowrap text-red-600 border-b-2 border-red-600">è¨‚å–®ç®¡ç†</button>
        <button onclick="switchAdminTab('history')" id="tab-history" class="px-4 py-2 font-bold whitespace-nowrap text-gray-400 hover:text-gray-600">è¨‚å–®ç¸½è¡¨</button>
        <button onclick="switchAdminTab('menu')" id="tab-menu" class="px-4 py-2 font-bold whitespace-nowrap text-gray-400 hover:text-gray-600">èœå–®ç®¡ç†</button>
    </div>
    <div id="admin-orders-panel"><div id="admin-orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
    <div id="admin-history-panel" class="hidden">
        <!-- æ­·å²ç¸½è¡¨å…§å®¹ (ç¶­æŒåŸæ¨£) -->
        <div class="bg-white rounded-xl shadow-sm border p-4 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                <select id="hist-filter-date" class="border rounded-lg px-3 py-2 text-sm" onchange="applyHistoryFilters()"></select>
                <select id="hist-filter-item" class="border rounded-lg px-3 py-2 text-sm" onchange="applyHistoryFilters()"></select>
                <select id="hist-filter-name" class="border rounded-lg px-3 py-2 text-sm" onchange="applyHistoryFilters()"></select>
                <button onclick="resetHistoryFilters()" class="bg-gray-200 text-gray-600 rounded-lg px-3 py-2 text-sm font-bold">é‡ç½®</button>
                <button onclick="triggerDeleteAllOrders()" class="bg-red-600 text-white rounded-lg px-3 py-2 text-sm font-bold">åˆªé™¤å…¨éƒ¨</button>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-700 border-b"><tr><th class="px-4 py-3">æ—¥æœŸ</th><th class="px-4 py-3">å§“å</th><th class="px-4 py-3">å“é …</th><th class="px-4 py-3">å–®åƒ¹</th><th class="px-4 py-3">æ•¸é‡</th><th class="px-4 py-3">å°è¨ˆ</th><th class="px-4 py-3">ç‹€æ…‹</th><th class="px-4 py-3">æ“ä½œ</th></tr></thead><tbody id="history-tbody" class="divide-y divide-gray-100"></tbody></table></div>
            <div class="bg-red-50 border-t border-red-100 p-4 flex justify-end gap-4 text-red-800 font-bold"><div>ç¸½é‡ï¼š<span id="hist-total-qty">0</span></div><div>ç¸½é¡ï¼š<span id="hist-total-amt">$0</span></div></div>
        </div>
    </div>
    <div id="admin-menu-panel" class="hidden">
        <div class="flex justify-between mb-4"><button onclick="loadAdminMenu()" class="bg-gray-100 px-3 py-1.5 rounded text-sm"><i class="fas fa-sync-alt"></i></button><button onclick="openMenuModal('add')" class="bg-red-600 text-white px-3 py-1.5 rounded text-sm font-bold">+ æ–°å¢å“é …</button></div>
        <div class="overflow-x-auto bg-white rounded-xl shadow border"><table class="w-full text-sm text-left"><thead class="bg-gray-50 border-b"><tr><th class="px-4 py-3">é¡åˆ¥</th><th class="px-4 py-3">åç¨±</th><th class="px-4 py-3">åƒ¹æ ¼</th><th class="px-4 py-3 text-center">æ“ä½œ</th></tr></thead><tbody id="admin-menu-tbody" class="divide-y"></tbody></table></div>
    </div>
</div>

<!-- å´é‚Šè³¼ç‰©è»Šã€å½ˆçª—ç­‰çµæ§‹ (ç¶­æŒåŸæ¨£) -->
<div id="cart-sidebar" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[60] flex flex-col">
  <div class="p-4 border-b flex justify-between items-center bg-gray-50"><h3 class="font-bold text-lg">å·²é¸é¤é»</h3><button onclick="toggleCart()" class="text-gray-400 text-2xl">&times;</button></div>
  <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-3"></div>
  <div class="p-4 border-t bg-gray-50"><div class="flex justify-between mb-4 items-end"><span class="text-gray-600 text-sm">ç¸½è¨ˆ</span><span class="text-red-600 font-black text-2xl" id="total-price">$0</span></div><button id="btn-submit" onclick="submitOrder()" class="w-full bg-red-600 text-white py-3.5 rounded-xl font-bold shadow-lg">é€å‡ºè¨‚å–®</button></div>
</div>
<div id="overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/40 hidden z-50"></div>

<!-- æ¨¡æ…‹æ¡† (å§“åã€é©—è­‰ã€ç·¨è¼¯èœå–®) -->
<div id="modal-name" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70] p-4">
    <div class="modal-overlay absolute w-full h-full bg-black/50" onclick="closeNameModal()"></div>
    <div class="modal-container bg-white w-full max-w-md mx-auto rounded-2xl shadow-2xl z-50 p-6 transform scale-95 transition-transform duration-300">
        <h3 class="text-xl font-bold mb-2">ğŸ‘‹ è¨­å®šè¨‚è³¼äºº</h3>
        <input id="input-name" type="text" class="w-full bg-gray-50 text-lg border-2 rounded-xl px-4 py-3 mb-4 focus:border-red-500 outline-none" placeholder="ä¾‹å¦‚ï¼šé–‹ç™¼éƒ¨ å°ç‹">
        <button onclick="saveName()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl shadow">ç¢ºå®š</button>
    </div>
</div>

<div id="modal-auth" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[80]">
    <div class="modal-overlay absolute w-full h-full bg-black/60" onclick="closeAuthModal()"></div>
    <div class="modal-container bg-white w-11/12 max-w-sm mx-auto rounded-2xl p-6 z-50">
        <h3 class="text-xl font-bold mb-2" id="auth-title">é©—è­‰èº«åˆ†</h3>
        <input id="input-auth-pwd" type="password" inputmode="numeric" class="w-full text-center text-2xl border rounded-xl px-4 py-2 mb-4 outline-none" placeholder="â—â—â—â—">
        <div class="flex gap-3"><button onclick="closeAuthModal()" class="flex-1 bg-gray-100 py-2 rounded-lg">å–æ¶ˆ</button><button id="btn-auth-confirm" class="flex-1 bg-red-600 text-white py-2 rounded-lg shadow">ç¢ºèª</button></div>
    </div>
</div>

<div id="modal-menu-edit" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70] p-4">
    <div class="modal-overlay absolute w-full h-full bg-black/50" onclick="closeMenuModal()"></div>
    <div class="modal-container bg-white w-full max-w-md rounded-2xl p-6 z-50 overflow-y-auto max-h-[90vh]">
        <h3 class="text-xl font-bold mb-4" id="menu-modal-title">ç·¨è¼¯å“é …</h3>
        <input type="hidden" id="menu-row-id">
        <div class="space-y-3">
            <input id="menu-cat" type="text" placeholder="åˆ†é¡" class="w-full border rounded-lg px-3 py-2">
            <input id="menu-name" type="text" placeholder="åç¨±" class="w-full border rounded-lg px-3 py-2">
            <input id="menu-price" type="number" placeholder="åƒ¹æ ¼" class="w-full border rounded-lg px-3 py-2">
            <textarea id="menu-desc" placeholder="æè¿°" rows="2" class="w-full border rounded-lg px-3 py-2"></textarea>
        </div>
        <div class="mt-6 flex gap-3"><button onclick="closeMenuModal()" class="flex-1 bg-gray-100 py-2 rounded-lg">å–æ¶ˆ</button><button onclick="triggerMenuSave()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg">å„²å­˜ (é©—è­‰)</button></div>
    </div>
</div>

<script>
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwW4SpBk1mboxHkQ2-meirj0VwyEkCVtzKpLiMXgQt8uaEeG4KMMGr5StKRNJnSD1YM/exec"; 

let menuData = [];
let cart = [];
let historyData = [];
let userName = localStorage.getItem("apan_user_name") || "";
let currentCategory = 'all';

window.onload = () => {
    if(userName) updateNameDisplay();
    // å„ªåŒ–ï¼šå…ˆè®€å–å¿«å–
    const localMenu = localStorage.getItem("apan_menu_cache");
    if (localMenu) {
        const cached = JSON.parse(localMenu);
        menuData = cached.data;
        document.getElementById('marquee-text').innerText = cached.marquee || "";
        renderClientMenu();
        document.getElementById('loading-spinner').style.display = 'none';
    }
    fetchMenu(); // èƒŒæ™¯åŒæ­¥æœ€æ–°è³‡æ–™
};

async function callApi(payload) {
    try {
        const res = await fetch(GAS_API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload)
        });
        return await res.json();
    } catch (e) { return { ok: false, message: "ç¶²è·¯å»¶é²ä¸­" }; }
}

async function fetchMenu() {
    const res = await callApi({ action: "getMenu" });
    if (res.ok) {
        menuData = res.data;
        localStorage.setItem("apan_menu_cache", JSON.stringify(res)); // æ›´æ–°å¿«å–
        document.getElementById('marquee-text').innerText = res.marquee;
        renderClientMenu();
        document.getElementById('loading-spinner').style.display = 'none';
    }
}

function renderClientMenu() {
    const nav = document.getElementById('category-nav');
    const validItems = menuData.filter(i => i.name);
    const cats = ['all', ...new Set(validItems.map(i => i.category))];
    nav.innerHTML = cats.map(c => `
        <button onclick="filterMenu('${c}')" class="category-btn ${c==='all'?'active':''} px-4 py-1.5 rounded-full border text-sm font-medium">
            ${c==='all'?'å…¨éƒ¨':c}
        </button>
    `).join('');
    displayMenu(currentCategory === 'all' ? validItems : validItems.filter(i => i.category === currentCategory));
}

function filterMenu(c) {
    currentCategory = c;
    document.querySelectorAll('.category-btn').forEach(b => {
        const txt = b.innerText.trim() === 'å…¨éƒ¨' ? 'all' : b.innerText.trim();
        b.classList.toggle('active', txt === c);
    });
    const items = (c === 'all') ? menuData : menuData.filter(i => i.category === c);
    displayMenu(items);
}

function displayMenu(items) {
    const container = document.getElementById('menu-container');
    container.innerHTML = items.map(i => {
        const inCart = cart.find(c => c.row === i.row);
        const qty = inCart ? inCart.qty : 0;
        let btnHtml = (qty === 0) 
            ? `<button onclick="addToCart(${i.row})" class="bg-red-50 text-red-600 font-bold px-4 py-2 rounded-full w-full">åŠ å…¥</button>`
            : `<div class="flex items-center justify-between bg-red-600 text-white rounded-full w-full px-1 py-1">
                <button onclick="updateItemQty(${i.row}, -1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full"><i class="fas fa-minus"></i></button>
                <span class="font-bold">${qty}</span>
                <button onclick="updateItemQty(${i.row}, 1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full"><i class="fas fa-plus"></i></button>
               </div>`;

        return `<div class="bg-white rounded-2xl shadow-sm border p-4 flex flex-col justify-between">
            <div>
                <span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-bold">${i.category}</span>
                <h3 class="font-bold text-lg mt-1">${i.name}</h3>
                <p class="text-xs text-gray-400 mt-1 line-clamp-2">${i.desc}</p>
            </div>
            <div class="flex justify-between items-end mt-3"><p class="text-red-600 font-black text-lg">$${i.price}</p><div class="w-28" id="btn-container-${i.row}">${btnHtml}</div></div>
        </div>`;
    }).join('');
}

function addToCart(rowId) {
    const item = menuData.find(m => m.row === rowId);
    if(item) { cart.push({...item, qty:1}); updateCartUI(); refreshMenuCardUI(rowId); }
}

function updateItemQty(rowId, delta) {
    const idx = cart.findIndex(c => c.row === rowId);
    if (idx !== -1) {
        cart[idx].qty += delta;
        if (cart[idx].qty <= 0) cart.splice(idx, 1);
    } else if (delta > 0) {
        addToCart(rowId); return;
    }
    updateCartUI(); refreshMenuCardUI(rowId);
}

function refreshMenuCardUI(rowId) {
    const container = document.getElementById(`btn-container-${rowId}`);
    if (!container) return;
    const inCart = cart.find(c => c.row === rowId);
    const qty = inCart ? inCart.qty : 0;
    container.innerHTML = (qty === 0)
        ? `<button onclick="addToCart(${rowId})" class="bg-red-50 text-red-600 font-bold px-4 py-2 rounded-full w-full">åŠ å…¥</button>`
        : `<div class="flex items-center justify-between bg-red-600 text-white rounded-full w-full px-1 py-1">
            <button onclick="updateItemQty(${rowId}, -1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full"><i class="fas fa-minus"></i></button>
            <span class="font-bold">${qty}</span>
            <button onclick="updateItemQty(${rowId}, 1)" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full"><i class="fas fa-plus"></i></button>
           </div>`;
}

function updateCartUI() {
    const list = document.getElementById('cart-items');
    let total = 0, count = 0;
    list.innerHTML = cart.length ? '' : '<div class="text-center text-gray-400 py-10">è³¼ç‰©è»Šç©ºçš„</div>';
    cart.forEach(c => {
        total += c.price * c.qty; count += c.qty;
        list.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl mb-2">
            <div class="flex-1 font-bold">${c.name}</div>
            <div class="flex items-center gap-2 bg-white px-2 py-1 rounded border">
                <button onclick="updateItemQty(${c.row},-1)" class="w-5 text-red-500"><i class="fas fa-minus text-xs"></i></button>
                <span class="font-bold w-4 text-center">${c.qty}</span>
                <button onclick="updateItemQty(${c.row},1)" class="w-5 text-green-500"><i class="fas fa-plus text-xs"></i></button>
            </div>
            <div class="w-16 text-right font-bold">$${c.price*c.qty}</div>
        </div>`;
    });
    document.getElementById('header-cart-count').innerText = count;
    document.getElementById('total-price').innerText = `$${total}`;
}

function toggleCart() {
    document.getElementById('cart-sidebar').classList.toggle('translate-x-full');
    document.getElementById('overlay').classList.toggle('hidden');
    document.body.classList.toggle('modal-active');
}

async function submitOrder() {
    if(!userName) { alert("è«‹è¨­å®šå§“å"); toggleCart(); openNameModal(); return; }
    if(!cart.length) return;
    const btn = document.getElementById('btn-submit');
    btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";
    const res = await callApi({ action: "submitOrder", name: userName, items: cart });
    if(res.ok) { alert("è¨‚å–®å·²é€å‡º"); cart = []; updateCartUI(); toggleCart(); location.reload(); }
    btn.disabled = false; btn.innerText = "é€å‡ºè¨‚å–®";
}

function switchView(view) {
    document.getElementById('view-client').classList.toggle('hidden', view !== 'client');
    document.getElementById('view-admin').classList.toggle('hidden', view !== 'admin');
    document.getElementById('btn-view-client').className = view === 'client' ? "px-5 py-2 rounded-lg bg-white text-red-800 shadow transition" : "px-5 py-2 rounded-lg text-red-200";
    document.getElementById('btn-view-admin').className = view === 'admin' ? "px-5 py-2 rounded-lg bg-white text-red-800 shadow transition" : "px-5 py-2 rounded-lg text-red-200";
    if(view === 'admin') loadAdminOrders();
}

function switchAdminTab(tab) {
    ['orders', 'history', 'menu'].forEach(t => {
        document.getElementById(`tab-${t}`).className = t === tab ? 'px-4 py-2 font-bold text-red-600 border-b-2 border-red-600' : 'px-4 py-2 font-bold text-gray-400';
        document.getElementById(`admin-${t}-panel`).classList.toggle('hidden', t !== tab);
    });
    if(tab === 'orders') loadAdminOrders();
    if(tab === 'history') loadHistoryData();
    if(tab === 'menu') loadAdminMenu();
}

async function loadAdminOrders() {
    const res = await callApi({ action: "getPendingOrdersMerged" });
    const container = document.getElementById('admin-orders-container');
    container.innerHTML = '';
    if(res.ok) {
        res.data.forEach(t => {
            const isServed = t.status === 'served';
            const btn = isServed ? `<button onclick="reqAuth('clearOrder', '${t.name}')" class="bg-gray-800 text-white px-3 py-1 rounded text-sm">çµå¸³é©—è­‰</button>` : `<button onclick="markStatus('${t.name}', 'served')" class="bg-green-500 text-white px-3 py-1 rounded text-sm">å–è²¨</button>`;
            container.innerHTML += `<div class="border rounded-xl p-4 shadow-sm ${isServed?'bg-green-50':'bg-white'}">
                <div class="flex justify-between mb-2"><h3 class="font-bold text-lg">${t.name}</h3>${btn}</div>
                <div class="text-sm space-y-1">${t.items.map(i => `<div class="flex justify-between border-b py-1"><span>${i.item} x${i.qty}</span><span>$${i.subtotal}</span></div>`).join('')}</div>
                <div class="text-right font-black text-red-600 mt-2">ç¸½é¡ $${t.total}</div>
            </div>`;
        });
    }
}

async function markStatus(table, status, pwd="") {
    const res = await callApi({ action: "markTableStatus", table, status, password: pwd });
    if(res.ok) loadAdminOrders(); else alert(res.message);
}

async function loadHistoryData() {
    const res = await callApi({ action: "getOrderHistory" });
    if(res.ok) {
        historyData = res.data;
        const dateSet = new Set();
        historyData.forEach(r => dateSet.add(new Date(r.time).toLocaleDateString()));
        document.getElementById('hist-filter-date').innerHTML = '<option value="all">æ‰€æœ‰æ—¥æœŸ</option>' + [...dateSet].map(d => `<option value="${d}">${d}</option>`).join('');
        applyHistoryFilters();
    }
}

function applyHistoryFilters() {
    const dv = document.getElementById('hist-filter-date').value;
    const tbody = document.getElementById('history-tbody');
    let tQty = 0, tAmt = 0;
    const filtered = historyData.filter(r => dv === 'all' || new Date(r.time).toLocaleDateString() === dv);
    tbody.innerHTML = filtered.map(r => {
        tQty += r.qty; tAmt += r.subtotal;
        return `<tr class="border-b">
            <td class="px-4 py-2">${new Date(r.time).getHours()}:${new Date(r.time).getMinutes()}</td>
            <td class="px-4 py-2">${r.name}</td>
            <td class="px-4 py-2">${r.item}</td>
            <td class="px-4 py-2">$${r.price}</td>
            <td class="px-4 py-2">${r.qty}</td>
            <td class="px-4 py-2">$${r.subtotal}</td>
            <td class="px-4 py-2 text-xs">${r.status}</td>
            <td class="px-4 py-2"><button onclick="reqAuth('deleteRow', ${r.row})" class="text-red-500"><i class="fas fa-trash"></i></button></td>
        </tr>`;
    }).join('');
    document.getElementById('hist-total-qty').innerText = tQty;
    document.getElementById('hist-total-amt').innerText = `$${tAmt}`;
}

function reqAuth(action, target) {
    document.getElementById('modal-auth').classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('btn-auth-confirm').onclick = async () => {
        const pwd = document.getElementById('input-auth-pwd').value;
        let res;
        if(action === 'clearOrder') res = await callApi({ action: "markTableStatus", table: target, status: "cleared", password: pwd });
        else if(action === 'deleteRow') res = await callApi({ action: "deleteOrder", row: target, password: pwd });
        else if(action === 'deleteAll') res = await callApi({ action: "deleteAllOrders", password: pwd });
        if(res && res.ok) { closeAuthModal(); loadAdminOrders(); loadHistoryData(); } else alert("éŒ¯èª¤");
    };
}

function openNameModal() { document.getElementById('modal-name').classList.remove('opacity-0', 'pointer-events-none'); }
function closeNameModal() { document.getElementById('modal-name').classList.add('opacity-0', 'pointer-events-none'); }
function saveName() { const n = document.getElementById('input-name').value; if(n){ userName=n; localStorage.setItem("apan_user_name", n); updateNameDisplay(); closeNameModal(); } }
function updateNameDisplay() { document.getElementById('display-name').innerText = userName; }
function closeAuthModal() { document.getElementById('modal-auth').classList.add('opacity-0', 'pointer-events-none'); }
function openMenuModal(mode, d=null) { 
    document.getElementById('modal-menu-edit').classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('menu-row-id').value = d?d.row:'';
    document.getElementById('menu-cat').value = d?d.category:'';
    document.getElementById('menu-name').value = d?d.name:'';
    document.getElementById('menu-price').value = d?d.price:'';
    document.getElementById('menu-desc').value = d?d.desc:'';
}
function closeMenuModal() { document.getElementById('modal-menu-edit').classList.add('opacity-0', 'pointer-events-none'); }
async function loadAdminMenu() {
    const res = await callApi({ action: "getMenu" });
    if(res.ok) document.getElementById('admin-menu-tbody').innerHTML = res.data.map(i => `<tr><td class="p-3">${i.category}</td><td class="p-3">${i.name}</td><td class="p-3">$${i.price}</td><td class="p-3 text-center"><button onclick='openMenuModal("edit", ${JSON.stringify(i)})' class="text-blue-500 mr-2"><i class="fas fa-edit"></i></button></td></tr>`).join('');
}
async function triggerMenuSave() {
    const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†ç¢¼");
    const payload = { 
        action: "saveMenuItem", 
        row: document.getElementById('menu-row-id').value,
        category: document.getElementById('menu-cat').value,
        name: document.getElementById('menu-name').value,
        price: document.getElementById('menu-price').value,
        desc: document.getElementById('menu-desc').value,
        password: pwd
    };
    const res = await callApi(payload);
    if(res.ok) { closeMenuModal(); loadAdminMenu(); fetchMenu(); } else alert("é©—è­‰å¤±æ•—");
}
</script>
</body>
</html>
