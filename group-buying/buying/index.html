<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>阿胖團購系統 - 高速版</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
  body { font-family: 'Noto Sans TC', sans-serif; background-color: #f9fafb; -webkit-tap-highlight-color: transparent; }
  .category-btn.active { background-color: #ef4444; color: white; border-color: #ef4444; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .modal { transition: opacity 0.2s ease, transform 0.2s ease; }
  .loading-overlay { background: rgba(255,255,255,0.7); backdrop-filter: blur(2px); }
</style>
</head>
<body class="pb-20 text-gray-800">

<header class="bg-red-600 text-white shadow-md sticky top-0 z-40">
  <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
    <h1 class="text-2xl font-bold flex items-center gap-2 shrink-0"><i class="fas fa-shopping-basket"></i> 阿胖團購</h1>
    <div class="flex items-center gap-3 flex-1 justify-center w-full md:w-auto">
        <div class="bg-red-800 p-1 rounded-xl flex text-sm font-bold shadow-inner w-full sm:w-auto">
            <button onclick="switchView('client')" id="btn-view-client" class="flex-1 px-6 py-2 rounded-lg bg-white text-red-800 shadow transition">我要訂購</button>
            <button onclick="switchView('admin')" id="btn-view-admin" class="flex-1 px-6 py-2 rounded-lg text-red-200 hover:text-white transition">訂單查詢</button>
        </div>
        <div onclick="toggleCart()" class="relative cursor-pointer bg-red-700 hover:bg-red-800 px-4 py-2 rounded-full transition shadow-lg border border-red-500">
            <i class="fas fa-shopping-cart text-xl"></i>
            <span id="header-cart-count" class="absolute -top-2 -right-2 bg-yellow-400 text-red-900 text-[10px] font-black w-5 h-5 flex items-center justify-center rounded-full border-2 border-red-600">0</span>
        </div>
    </div>
  </div>
</header>

<div id="view-client">
    <div class="bg-orange-50 border-b border-orange-100 p-3">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-2">
            <marquee id="marquee-text" class="text-orange-800 font-medium flex-1">載入中...</marquee>
            <button onclick="openNameModal()" class="text-sm bg-white border border-orange-200 text-orange-700 px-4 py-1.5 rounded-full shadow-sm">
                <i class="fas fa-user mr-1"></i><span id="display-name">設定訂購人</span>
            </button>
        </div>
    </div>
    <nav id="category-nav" class="sticky top-[125px] md:top-[72px] bg-white/95 backdrop-blur border-b overflow-x-auto whitespace-nowrap z-30 px-4 py-3 flex gap-2 no-scrollbar shadow-sm"></nav>
    <main class="container mx-auto p-4 min-h-[60vh]">
        <div id="loading-spinner" class="text-center py-20"><i class="fas fa-spinner fa-spin text-3xl text-red-500"></i></div>
        <div id="menu-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>
</div>

<div id="view-admin" class="hidden container mx-auto p-4">
    <div class="flex gap-4 border-b mb-6 overflow-x-auto no-scrollbar">
        <button onclick="switchAdminTab('orders')" id="tab-orders" class="px-4 py-2 font-bold text-red-600 border-b-2 border-red-600">待領取</button>
        <button onclick="switchAdminTab('history')" id="tab-history" class="px-4 py-2 font-bold text-gray-400">所有訂單</button>
        <button onclick="switchAdminTab('menu')" id="tab-menu" class="px-4 py-2 font-bold text-gray-400">菜單管理</button>
    </div>
    <div id="admin-orders-panel"><div id="admin-orders-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
    <div id="admin-history-panel" class="hidden"><div class="overflow-x-auto bg-white rounded-lg border"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="p-3 text-left">時間</th><th class="p-3 text-left">姓名</th><th class="p-3 text-left">品項</th><th class="p-3 text-right">小計</th><th class="p-3 text-center">操作</th></tr></thead><tbody id="history-tbody"></tbody></table></div></div>
    <div id="admin-menu-panel" class="hidden"><div class="flex justify-end mb-4"><button onclick="openMenuModal('add')" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm">+ 新增品項</button></div><div class="bg-white rounded-lg border overflow-hidden"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="p-3 text-left">名稱</th><th class="p-3 text-left">價格</th><th class="p-3 text-center">操作</th></tr></thead><tbody id="admin-menu-tbody"></tbody></table></div></div>
</div>

<div id="cart-sidebar" class="fixed inset-y-0 right-0 w-full sm:w-[380px] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[60] flex flex-col">
    <div class="p-4 border-b flex justify-between items-center">
        <h3 class="font-bold text-lg">我的購物車</h3>
        <button onclick="toggleCart()" class="text-2xl">&times;</button>
    </div>
    <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-3"></div>
    <div class="p-4 border-t">
        <div class="flex justify-between mb-4 font-bold text-xl"><span>總計</span><span id="total-price" class="text-red-600">$0</span></div>
        <button id="btn-submit" onclick="submitOrder()" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold">送出訂單</button>
    </div>
</div>
<div id="overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/50 hidden z-50"></div>

<div id="modal-name" class="modal opacity-0 pointer-events-none fixed inset-0 flex items-center justify-center z-[70] p-4">
    <div class="absolute inset-0 bg-black/50" onclick="closeNameModal()"></div>
    <div class="bg-white w-full max-w-sm rounded-2xl p-6 relative z-10">
        <h3 class="text-lg font-bold mb-4">輸入訂購人姓名</h3>
        <input id="input-name" type="text" class="w-full border-2 rounded-xl p-3 mb-4 focus:border-red-500 outline-none" placeholder="例如：小明">
        <button onclick="saveName()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold">儲存</button>
    </div>
</div>

<script>
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwW4SpBk1mboxHkQ2-meirj0VwyEkCVtzKpLiMXgQt8uaEeG4KMMGr5StKRNJnSD1YM/exec"; // 請更換為你的 URL

let menuData = [];
let cart = [];
let userName = localStorage.getItem("apan_user_name") || "";

window.onload = () => {
    if(userName) updateNameDisplay();
    fetchMenu();
};

async function callApi(payload) {
    try {
        const res = await fetch(GAS_API_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        });
        return await res.json();
    } catch (e) {
        alert("網路連線失敗，請檢查網路。");
        return { ok: false };
    }
}

async function fetchMenu() {
    const res = await callApi({ action: "getMenu" });
    if (res.ok) {
        menuData = res.data;
        document.getElementById('marquee-text').innerText = res.marquee || "歡迎光臨";
        renderCategoryNav();
        filterMenu('all');
        document.getElementById('loading-spinner').classList.add('hidden');
    }
}

function renderCategoryNav() {
    const cats = ['all', ...new Set(menuData.map(i => i.category))];
    document.getElementById('category-nav').innerHTML = cats.map(c => `
        <button onclick="filterMenu('${c}')" class="category-btn px-4 py-1.5 rounded-full border text-sm transition">
            ${c === 'all' ? '全部' : c}
        </button>
    `).join('');
}

function filterMenu(cat) {
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.toggle('active', btn.innerText === (cat === 'all' ? '全部' : cat));
    });
    const items = cat === 'all' ? menuData : menuData.filter(i => i.category === cat);
    const container = document.getElementById('menu-container');
    container.innerHTML = items.map(i => {
        const itemInCart = cart.find(c => c.row === i.row);
        const qty = itemInCart ? itemInCart.qty : 0;
        return `
        <div class="bg-white p-4 rounded-xl shadow-sm border flex flex-col justify-between">
            <div>
                <span class="text-[10px] text-orange-500 font-bold">${i.category}</span>
                <h3 class="font-bold text-lg">${i.name}</h3>
                <p class="text-gray-400 text-xs">${i.desc || ''}</p>
            </div>
            <div class="flex justify-between items-center mt-4">
                <span class="text-red-600 font-bold text-xl">$${i.price}</span>
                <div class="flex items-center gap-2">
                    ${qty > 0 ? `
                        <button onclick="updateQty(${i.row}, -1)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600">-</button>
                        <span class="font-bold w-4 text-center">${qty}</span>
                    ` : ''}
                    <button onclick="updateQty(${i.row}, 1)" class="w-8 h-8 rounded-full bg-red-600 text-white">+</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function updateQty(rowId, delta) {
    const menuIdx = menuData.findIndex(m => m.row === rowId);
    const cartIdx = cart.findIndex(c => c.row === rowId);
    
    if (cartIdx > -1) {
        cart[cartIdx].qty += delta;
        if (cart[cartIdx].qty <= 0) cart.splice(cartIdx, 1);
    } else if (delta > 0) {
        cart.push({ ...menuData[menuIdx], qty: 1 });
    }
    
    updateCartUI();
    filterMenu(document.querySelector('.category-btn.active').innerText === '全部' ? 'all' : document.querySelector('.category-btn.active').innerText);
}

function updateCartUI() {
    const count = cart.reduce((sum, i) => sum + i.qty, 0);
    const total = cart.reduce((sum, i) => sum + (i.qty * i.price), 0);
    document.getElementById('header-cart-count').innerText = count;
    document.getElementById('total-price').innerText = `$${total}`;
    
    const list = document.getElementById('cart-items');
    list.innerHTML = cart.map(i => `
        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
            <div><div class="font-bold">${i.name}</div><div class="text-xs text-gray-400">$${i.price}</div></div>
            <div class="flex items-center gap-3">
                <button onclick="updateQty(${i.row},-1)" class="w-7 h-7 rounded-full border">-</button>
                <span class="font-bold">${i.qty}</span>
                <button onclick="updateQty(${i.row},1)" class="w-7 h-7 rounded-full border">+</button>
            </div>
        </div>
    `).join('');
}

async function submitOrder() {
    if (!userName) { alert("請先設定訂購人姓名"); openNameModal(); return; }
    if (cart.length === 0) return;
    
    const btn = document.getElementById('btn-submit');
    btn.disabled = true;
    btn.innerText = "提交中...";
    
    const res = await callApi({ action: "submitOrder", name: userName, items: cart });
    if (res.ok) {
        alert("訂單已送出！");
        cart = [];
        updateCartUI();
        toggleCart();
        filterMenu('all');
    }
    btn.disabled = false;
    btn.innerText = "送出訂單";
}

// 基礎 UI 控制
function toggleCart() {
    const side = document.getElementById('cart-sidebar');
    const over = document.getElementById('overlay');
    const isHidden = side.classList.contains('translate-x-full');
    side.classList.toggle('translate-x-full', !isHidden);
    over.classList.toggle('hidden', !isHidden);
}

function openNameModal() { document.getElementById('modal-name').classList.remove('opacity-0', 'pointer-events-none'); }
function closeNameModal() { document.getElementById('modal-name').classList.add('opacity-0', 'pointer-events-none'); }
function saveName() {
    const val = document.getElementById('input-name').value.trim();
    if (val) {
        userName = val;
        localStorage.setItem("apan_user_name", val);
        updateNameDisplay();
        closeNameModal();
    }
}
function updateNameDisplay() { document.getElementById('display-name').innerText = userName; }

function switchView(view) {
    document.getElementById('view-client').classList.toggle('hidden', view !== 'client');
    document.getElementById('view-admin').classList.toggle('hidden', view !== 'admin');
    if (view === 'admin') loadAdminOrders();
}

async function loadAdminOrders() {
    const container = document.getElementById('admin-orders-container');
    container.innerHTML = '<p class="col-span-full text-center">載入中...</p>';
    const res = await callApi({ action: "getPendingOrdersMerged" });
    if (res.ok) {
        container.innerHTML = res.data.map(o => `
            <div class="bg-white p-4 rounded-xl shadow border ${o.status === 'served' ? 'border-green-500 bg-green-50' : ''}">
                <div class="flex justify-between font-bold mb-2"><span>${o.name}</span><span class="text-red-600">$${o.total}</span></div>
                <div class="text-sm space-y-1 mb-4">${o.items.map(i => `<div>${i.item} x ${i.qty}</div>`).join('')}</div>
                <div class="flex gap-2">
                    <button onclick="markStatus('${o.name}', 'served')" class="flex-1 bg-green-600 text-white py-2 rounded">已取餐</button>
                    <button onclick="markStatus('${o.name}', 'cleared')" class="flex-1 bg-blue-600 text-white py-2 rounded">結帳</button>
                </div>
            </div>
        `).join('') || '<p class="col-span-full text-center text-gray-400">目前沒有待處理訂單</p>';
    }
}

async function markStatus(name, status) {
    let pwd = "";
    if (status === 'cleared') {
        pwd = prompt("請輸入管理密碼以結帳：");
        if (!pwd) return;
    }
    const res = await callApi({ action: "markTableStatus", table: name, status: status, password: pwd });
    if (res.ok) loadAdminOrders();
    else alert(res.message || "操作失敗");
}
</script>
</body>
</html>
