<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾½çƒéšŠåœ˜è³¼ - è¨‚è³¼ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .product-card { transition: transform 0.2s; }
        .desc-tag { background: #fff7ed; color: #9a3412; border: 1px solid #ffedd5; }
        .sticky-cart { backdrop-filter: blur(12px); background: rgba(255, 255, 255, 0.9); }
    </style>
</head>
<body class="pb-32">

    <header class="bg-red-600 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black tracking-tight">é˜¿èƒ–åœ˜è³¼å•†åŸ</h1>
                <p id="announcement" class="text-[10px] opacity-80 font-bold mt-0.5">æ­¡è¿é¸è³¼</p>
            </div>
            <div onclick="toggleCart()" class="relative cursor-pointer bg-white/20 p-2.5 rounded-2xl">
                <i class="fas fa-shopping-basket text-xl"></i>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-yellow-400 text-red-900 text-[10px] font-black px-1.5 py-0.5 rounded-full shadow-sm">0</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <div id="loading" class="flex flex-col items-center justify-center py-20 text-slate-400">
            <i class="fas fa-circle-notch fa-spin text-3xl mb-4 text-red-500"></i>
            <p class="font-bold">ç”¢å“è¼‰å…¥ä¸­...</p>
        </div>
        <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </main>

    <div id="cart-bar" class="fixed bottom-0 left-0 right-0 p-4 sticky-cart border-t border-gray-100 hidden z-30">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <p class="text-[10px] text-gray-400 font-bold uppercase">é è¨ˆç¸½é¡</p>
                <p id="bar-total" class="text-xl font-black text-red-600">$0</p>
            </div>
            <button onclick="toggleCart()" class="bg-red-600 text-white px-8 py-3 rounded-2xl font-black shadow-lg shadow-red-200 active:scale-95 transition">
                æŸ¥çœ‹è³¼ç‰©è»Š
            </button>
        </div>
    </div>

    <div id="cart-drawer" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end">
        <div class="bg-white w-full rounded-t-[32px] p-6 max-h-[92vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-gray-800">çµå¸³æ¸…å–®</h2>
                <button onclick="toggleCart()" class="bg-gray-100 text-gray-400 w-10 h-10 rounded-full flex items-center justify-center text-xl">&times;</button>
            </div>

            <div id="cart-items" class="space-y-4 mb-8"></div>

            <div class="bg-gray-50 rounded-3xl p-5 space-y-4">
                <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest">é ˜è²¨äººè³‡è¨Š</h3>
                <input id="user-name" type="text" placeholder="æ‚¨çš„å§“å (å¿…å¡«)" class="w-full p-4 rounded-2xl border-2 border-transparent focus:border-red-500 bg-white outline-none transition font-bold shadow-sm">
                <input id="user-email" type="email" placeholder="Email (é¸å¡«)" class="w-full p-4 rounded-2xl border-2 border-transparent focus:border-red-500 bg-white outline-none transition font-bold shadow-sm text-sm">
                <textarea id="user-note" placeholder="è³¼ç‰©è»Šç¸½é«”å‚™è¨» (é¸å¡«ï¼Œå°‡å¯«å…¥ I æ¬„)" class="w-full p-4 rounded-2xl border-2 border-transparent focus:border-red-500 bg-white outline-none transition font-bold shadow-sm text-sm h-24"></textarea>
            </div>

            <div class="mt-8 flex flex-col gap-4">
                <div class="flex justify-between items-center px-2">
                    <span class="font-bold text-gray-500">ç¸½è¨ˆé‡‘é¡</span>
                    <span id="drawer-total" class="text-3xl font-black text-red-600">$0</span>
                </div>
                <button onclick="sendOrder()" id="send-btn" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition">
                    ç¢ºèªé€å‡ºè¨‚å–®
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzZh7SZLScf3JitSON8sMFXcPEF5umYW0Px7IRhtDRdlOPRJ5EF4p199STCQKgSN5iH/exec";
        
        let menuData = [];
        let cart = {};

        async function fetchMenu() {
            try {
                const response = await fetch(`${API_URL}?action=getMenu`);
                const res = await response.json();
                menuData = res.data;
                document.getElementById('announcement').innerText = "ğŸ“¢ " + (res.announcement || "æ­¡è¿é¸è³¼");
                renderMenu();
                document.getElementById('loading').classList.add('hidden');
            } catch (e) {
                document.getElementById('announcement').innerText = "âŒ ç„¡æ³•è¼‰å…¥è³‡æ–™";
            }
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            container.innerHTML = menuData.map(item => `
                <div class="bg-white rounded-[28px] shadow-sm border border-gray-100 overflow-hidden product-card flex flex-col">
                    <img src="${item.image || 'https://via.placeholder.com/400x300?text=No+Image'}" class="w-full h-48 object-cover">
                    <div class="p-5 flex flex-col flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-black text-gray-800 leading-tight">${item.name}</h3>
                            <span class="text-red-600 font-black text-lg">$${item.price}</span>
                        </div>
                        <div class="desc-tag px-3 py-2 rounded-xl text-xs font-bold mb-4">${item.desc || 'ç„¡æè¿°'}</div>
                        
                        <div class="mb-4">
                            <input type="text" id="note-${item.name}" placeholder="ç”¢å“å‚™è¨» (å¦‚ï¼šé¡è‰²ã€å»å†°)" 
                                   onchange="syncNote('${item.name}', this.value)"
                                   class="w-full bg-slate-50 border-none p-3 rounded-xl text-xs font-bold outline-none transition focus:ring-1 focus:ring-red-400">
                        </div>

                        <div class="mt-auto flex items-center justify-between bg-slate-100 p-1.5 rounded-2xl">
                            <button onclick="updateQty('${item.name}', -1)" class="w-12 h-12 bg-white rounded-xl shadow-sm font-black text-red-600 text-xl">-</button>
                            <span id="qty-${item.name}" class="font-black text-xl text-slate-800">${cart[item.name]?.qty || 0}</span>
                            <button onclick="updateQty('${item.name}', 1)" class="w-12 h-12 bg-red-600 rounded-xl shadow-sm font-black text-white text-xl">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // åŒæ­¥å‚™è¨»å…§å®¹åˆ° cart ç‰©ä»¶
        function syncNote(name, val) {
            if (cart[name]) {
                cart[name].note = val;
            }
        }

        function updateQty(name, delta) {
            if (!cart[name]) {
                if (delta > 0) {
                    // ç¬¬ä¸€æ¬¡é»æ“Šï¼šå¾ 1 é–‹å§‹ï¼Œä¸¦åŒæ™‚æŠ“å–ç›®å‰çš„å‚™è¨»å…§å®¹
                    const currentNote = document.getElementById(`note-${name}`).value;
                    cart[name] = { qty: 1, note: currentNote };
                } else return;
            } else {
                cart[name].qty += delta;
            }

            if (cart[name].qty <= 0) delete cart[name];
            updateUI();
        }

        function updateUI() {
            menuData.forEach(item => {
                const el = document.getElementById(`qty-${item.name}`);
                if (el) el.innerText = cart[item.name]?.qty || 0;
            });

            const totalCount = Object.values(cart).reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cart-count').innerText = totalCount;

            const totalAmount = calculateTotal();
            document.getElementById('bar-total').innerText = `$${totalAmount}`;
            document.getElementById('cart-bar').classList.toggle('hidden', totalCount === 0);
        }

        function calculateTotal() {
            return Object.keys(cart).reduce((sum, name) => {
                const product = menuData.find(p => p.name === name);
                return sum + (product.price * cart[name].qty);
            }, 0);
        }

        function toggleCart() {
            const drawer = document.getElementById('cart-drawer');
            drawer.classList.toggle('hidden');
            if (!drawer.classList.contains('hidden')) renderCartItems();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            const keys = Object.keys(cart);

            if (keys.length === 0) {
                container.innerHTML = '<p class="text-center py-10 text-gray-400 font-bold">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>';
            } else {
                container.innerHTML = keys.map(name => {
                    const product = menuData.find(p => p.name === name);
                    return `
                        <div class="flex flex-col border-b border-gray-50 pb-3">
                            <div class="flex justify-between items-center font-black text-gray-800">
                                <span>${name} x ${cart[name].qty}</span>
                                <span>$${product.price * cart[name].qty}</span>
                            </div>
                            <p class="text-[11px] ${cart[name].note ? 'text-blue-500' : 'text-gray-300'} font-bold mt-1 italic">
                                <i class="fas fa-pen-nib mr-1"></i>å‚™è¨»ï¼š${cart[name].note || 'ç„¡'}
                            </p>
                        </div>
                    `;
                }).join('');
            }
            document.getElementById('drawer-total').innerText = `$${calculateTotal()}`;
        }

        async function sendOrder() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const generalNote = document.getElementById('user-note').value.trim(); // ç¸½é«”å‚™è¨» (Iæ¬„)
            
            if (!name) { alert("è«‹è¼¸å…¥æ‚¨çš„å§“åï¼"); return; }
            if (Object.keys(cart).length === 0) { alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼"); return; }

            const btn = document.getElementById('send-btn');
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨é€å‡º...";

            // æ•´ç†ç”¢å“æ•¸æ“šï¼ŒåŒ…å«ç”¢å“å‚™è¨» (Hæ¬„)
            const items = Object.keys(cart).map(n => {
                const product = menuData.find(m => m.name === n);
                return {
                    name: n,
                    qty: cart[n].qty,
                    price: product.price,
                    note: cart[n].note // ç”¢å“å€‹åˆ¥å‚™è¨»
                };
            });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: 'submitOrder', 
                        name, 
                        email, 
                        items, 
                        generalNote // é€™è£¡ç¨ç«‹å‚³é€ç¸½é«”å‚™è¨»
                    })
                });
                alert("ğŸ‰ è¨‚è³¼æˆåŠŸï¼");
                location.reload();
            } catch (e) {
                alert("å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦");
                btn.disabled = false;
                btn.innerText = "ç¢ºèªé€å‡ºè¨‚å–®";
            }
        }

        fetchMenu();
    </script>
</body>
</html>
