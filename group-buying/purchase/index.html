<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾½çƒéšŠåœ˜è³¼ - è¨‚è³¼ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .product-card { transition: transform 0.2s; }
        .desc-tag { background: #fff7ed; color: #9a3412; border: 1px solid #ffedd5; }
        .sticky-cart { backdrop-filter: blur(8px); background: rgba(255, 255, 255, 0.9); }
    </style>
</head>
<body class="pb-28">

    <header class="bg-red-600 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black tracking-tight">é˜¿èƒ–åœ˜è³¼å•†åŸ</h1>
                <p id="announcement" class="text-[10px] opacity-80 font-bold mt-0.5">è¼‰å…¥å…¬å‘Šä¸­...</p>
            </div>
            <div onclick="toggleCart()" class="relative cursor-pointer bg-white/20 p-2.5 rounded-2xl">
                <i class="fas fa-shopping-basket text-xl"></i>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-yellow-400 text-red-900 text-[10px] font-black px-1.5 py-0.5 rounded-full shadow-sm">0</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <div id="loading" class="flex flex-col items-center justify-center py-20 text-slate-400">
            <i class="fas fa-circle-notch fa-spin text-3xl mb-4 text-red-500"></i>
            <p class="font-bold">æ­£åœ¨æ¬é‹å•†å“ï¼Œè«‹ç¨å€™...</p>
        </div>

        <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </main>

    <div id="cart-bar" class="fixed bottom-0 left-0 right-0 p-4 sticky-cart border-t border-gray-100 hidden z-30">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <p class="text-[10px] text-gray-400 font-bold uppercase">é è¨ˆç¸½é¡</p>
                <p id="bar-total" class="text-xl font-black text-red-600">$0</p>
            </div>
            <button onclick="toggleCart()" class="bg-red-600 text-white px-8 py-3 rounded-2xl font-black shadow-lg shadow-red-200 active:scale-95 transition">
                æŸ¥çœ‹è³¼ç‰©è»Š
            </button>
        </div>
    </div>

    <div id="cart-drawer" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end">
        <div class="bg-white w-full rounded-t-[32px] p-6 max-h-[92vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-gray-800">ç¢ºèªè¨‚å–®å…§å®¹</h2>
                <button onclick="toggleCart()" class="bg-gray-100 text-gray-400 w-10 h-10 rounded-full flex items-center justify-center text-xl">&times;</button>
            </div>

            <div id="cart-items" class="space-y-4 mb-8"></div>

            <div class="bg-gray-50 rounded-3xl p-5 space-y-4">
                <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest"><i class="fas fa-user-edit mr-2"></i>å¡«å¯«é ˜è²¨äººè³‡è¨Š</h3>
                <div>
                    <input id="user-name" type="text" placeholder="æ‚¨çš„å§“å (å¿…å¡«)" class="w-full p-4 rounded-2xl border-2 border-transparent focus:border-red-500 focus:bg-white bg-white outline-none transition font-bold shadow-sm">
                </div>
                <div>
                    <input id="user-email" type="email" placeholder="é›»å­éƒµä»¶ (é¸å¡«ï¼Œç”¨æ–¼æ¥æ”¶æ˜ç´°)" class="w-full p-4 rounded-2xl border-2 border-transparent focus:border-red-500 bg-white outline-none transition font-bold shadow-sm text-sm">
                </div>
                <div>
                    <textarea id="user-note" placeholder="çµ¦ç®¡ç†å“¡çš„ç¸½é«”å‚™è¨» (é¸å¡«)" class="w-full p-4 rounded-2xl border-2 border-transparent focus:border-red-500 bg-white outline-none transition font-bold shadow-sm text-sm h-24"></textarea>
                </div>
            </div>

            <div class="mt-8 flex flex-col gap-4">
                <div class="flex justify-between items-center px-2">
                    <span class="font-bold text-gray-500">æ‡‰ä»˜ç¸½è¨ˆ</span>
                    <span id="drawer-total" class="text-3xl font-black text-red-600">$0</span>
                </div>
                <button onclick="sendOrder()" id="send-btn" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition">
                    ç¢ºèªé€å‡ºè¨‚å–®
                </button>
            </div>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS ç¶²å€ â˜…â˜…â˜…
        const API_URL = "https://script.google.com/macros/s/AKfycbys9mXPh-laeLcOTSVxNsFTz1ULzvaUbxYrif0K7bC8wWlmxmLsbnS5BLdWc2FOspvzgw/exec";
        
        let menuData = [];
        let cart = {}; // çµæ§‹: { "ç”¢å“å": { qty: 2, note: "å»å†°" } }

        // 1. åˆå§‹åŒ–è®€å–
        async function fetchMenu() {
            try {
                const response = await fetch(`${API_URL}?action=getMenu`);
                const res = await response.json();
                menuData = res.data;
                document.getElementById('announcement').innerText = "ğŸ“¢ " + (res.announcement || "æ­¡è¿é¸è³¼");
                renderMenu();
                document.getElementById('loading').classList.add('hidden');
            } catch (e) {
                document.getElementById('announcement').innerText = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€";
            }
        }

        // 2. æ¸²æŸ“å•†å“å¡ç‰Œ
        function renderMenu() {
            const container = document.getElementById('menu-container');
            container.innerHTML = menuData.map(item => `
                <div class="bg-white rounded-[28px] shadow-sm border border-gray-100 overflow-hidden product-card flex flex-col">
                    <div class="relative h-48 overflow-hidden">
                        <img src="${item.image || 'https://via.placeholder.com/400x300?text=No+Image'}" class="w-full h-full object-cover">
                        <span class="absolute top-3 left-3 bg-white/90 px-3 py-1 rounded-full text-[10px] font-black text-slate-800">${item.category}</span>
                    </div>
                    <div class="p-5 flex flex-col flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-black text-gray-800 leading-tight">${item.name}</h3>
                            <span class="text-red-600 font-black text-lg">$${item.price}</span>
                        </div>
                        
                        <div class="desc-tag px-3 py-2 rounded-xl text-xs font-bold mb-4">
                            <i class="fas fa-info-circle mr-1 opacity-50"></i>${item.desc || 'ç„¡ç‰¹åˆ¥èªªæ˜'}
                        </div>

                        <div class="mb-4">
                            <input type="text" 
                                   id="note-${item.name}" 
                                   placeholder="æ­¤é …å‚™è¨» (å¦‚ï¼šé¡è‰²ã€å£å‘³)" 
                                   onchange="updateProductNote('${item.name}', this.value)"
                                   class="w-full bg-slate-50 border-none p-3 rounded-xl text-xs font-bold focus:ring-1 focus:ring-red-400 outline-none transition">
                        </div>

                        <div class="mt-auto flex items-center justify-between bg-slate-100 p-1.5 rounded-2xl">
                            <button onclick="updateQty('${item.name}', -1)" class="w-12 h-12 bg-white rounded-xl shadow-sm font-black text-red-600 text-xl active:bg-gray-50">-</button>
                            <span id="qty-${item.name}" class="font-black text-xl text-slate-800">${cart[item.name]?.qty || 0}</span>
                            <button onclick="updateQty('${item.name}', 1)" class="w-12 h-12 bg-red-600 rounded-xl shadow-sm font-black text-white text-xl active:bg-red-700">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 3. è™•ç†æ•¸é‡èˆ‡å‚™è¨»
        function updateQty(name, delta) {
            if (!cart[name]) cart[name] = { qty: 0, note: "" };
            cart[name].qty += delta;

            // æŠ“å–ç›®å‰å‚™è¨»æ¡†çš„å…§å®¹
            const noteInput = document.getElementById(`note-${name}`);
            if (noteInput) cart[name].note = noteInput.value;

            if (cart[name].qty <= 0) {
                delete cart[name];
                if (noteInput) noteInput.value = "";
            }

            updateUI();
        }

        function updateProductNote(name, value) {
            if (cart[name]) {
                cart[name].note = value;
            } else if (value.trim() !== "") {
                // å¦‚æœæœ‰å¡«å‚™è¨»ä½†æ²’æŒ‰åŠ è™Ÿï¼Œé è¨­çµ¦ 1 å€‹
                cart[name] = { qty: 1, note: value };
                updateUI();
            }
        }

        function updateUI() {
            // æ›´æ–°å¡ç‰Œæ•¸å­—
            menuData.forEach(item => {
                const el = document.getElementById(`qty-${item.name}`);
                if (el) el.innerText = cart[item.name]?.qty || 0;
            });

            // æ›´æ–°è³¼ç‰©è»Šåœ–ç¤ºæ•¸é‡
            const totalCount = Object.values(cart).reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cart-count').innerText = totalCount;

            // æ›´æ–°åº•éƒ¨é¡¯ç¤ºæ¢
            const totalAmount = calculateTotal();
            document.getElementById('bar-total').innerText = `$${totalAmount}`;
            document.getElementById('cart-bar').classList.toggle('hidden', totalCount === 0);
        }

        function calculateTotal() {
            return Object.keys(cart).reduce((sum, name) => {
                const product = menuData.find(p => p.name === name);
                return sum + (product.price * cart[name].qty);
            }, 0);
        }

        // 4. è³¼ç‰©è»ŠæŠ½å±œ
        function toggleCart() {
            const drawer = document.getElementById('cart-drawer');
            drawer.classList.toggle('hidden');
            if (!drawer.classList.contains('hidden')) renderCartItems();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            const total = calculateTotal();
            const keys = Object.keys(cart);

            if (keys.length === 0) {
                container.innerHTML = '<p class="text-center py-10 text-gray-400 font-bold">è³¼ç‰©è»Šå…§ç©ºç©ºå¦‚ä¹Ÿ...</p>';
            } else {
                container.innerHTML = keys.map(name => {
                    const product = menuData.find(p => p.name === name);
                    return `
                        <div class="flex flex-col border-b border-gray-50 pb-3">
                            <div class="flex justify-between items-center font-black text-gray-800">
                                <span>${name} <span class="text-red-600 text-sm">x ${cart[name].qty}</span></span>
                                <span>$${product.price * cart[name].qty}</span>
                            </div>
                            ${cart[name].note ? `<p class="text-[11px] text-blue-500 font-bold mt-1"><i class="fas fa-tag mr-1"></i>å‚™è¨»ï¼š${cart[name].note}</p>` : ''}
                        </div>
                    `;
                }).join('');
            }
            document.getElementById('drawer-total').innerText = `$${total}`;
        }

        // 5. é€å‡ºè¨‚å–® (åŒ…å«é˜²å‘†æª¢æŸ¥)
        async function sendOrder() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const generalNote = document.getElementById('user-note').value.trim();
            
            // é˜²å‘† 1: æª¢æŸ¥å§“å
            if (!name) {
                alert("è«‹è¼¸å…¥æ‚¨çš„å§“åï¼Œæ–¹ä¾¿åœ˜ä¸»æ ¸å°é ˜è²¨ï¼");
                document.getElementById('user-name').focus();
                return;
            }

            // é˜²å‘† 2: æª¢æŸ¥è³¼ç‰©è»Šæœ‰ç„¡å…§å®¹
            const cartKeys = Object.keys(cart);
            if (cartKeys.length === 0) {
                alert("æ‚¨çš„è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œè«‹å…ˆæŒ‘é¸å•†å“ã€‚");
                toggleCart();
                return;
            }

            if (!confirm("ç¢ºå®šè¦é€å‡ºè¨‚å–®å—ï¼Ÿ")) return;

            const btn = document.getElementById('send-btn');
            btn.disabled = true;
            btn.innerText = "å‚³é€ä¸­...";

            // æ•´ç†è³‡æ–™ï¼šå°‡å€‹åˆ¥å‚™è¨»èˆ‡ç¸½å‚™è¨»åˆä½µå¯«å…¥ H æ¬„
            const items = cartKeys.map(n => {
                const product = menuData.find(m => m.name === n);
                // å€‹åˆ¥é …ç›®çš„å‚™è¨»
                const itemNote = cart[n].note ? `(${cart[n].note})` : "";
                return {
                    name: n,
                    qty: cart[n].qty,
                    price: product.price,
                    // æ­¤ note å°‡åœ¨ GAS ç«¯å¯«å…¥ H æ¬„
                    note: `${itemNote} ${generalNote}`.trim()
                };
            });

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: 'submitOrder', 
                        name: name, 
                        email: email, 
                        note: generalNote, // é€™è£¡æ˜¯ç¸½å‚™è¨»
                        items: items       // é€™è£¡åŒ…å«æ¯å€‹å“é …åŠå…¶åˆä½µå¾Œçš„å‚™è¨»
                    })
                });
                
                alert("ğŸ‰ è¨‚å–®é€å‡ºæˆåŠŸï¼è«‹æº–æ™‚é ˜è²¨ã€‚");
                location.reload();
            } catch (e) {
                alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æˆªåœ–è³¼ç‰©è»Šä¸¦è¯çµ¡åœ˜ä¸»ã€‚");
                btn.disabled = false;
                btn.innerText = "é‡æ–°é€å‡ºè¨‚å–®";
            }
        }

        fetchMenu();
    </script>
</body>
</html>
