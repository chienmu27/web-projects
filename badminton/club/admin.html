<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¸ é–‹åœ˜ç®¡ç† - ç¾½çƒç³»çµ±</title>
    <style>
        :root { --primary: #1976d2; --accent: #e91e63; --bg: #f5f7fa; --green: #4caf50; --gray: #757575; --wait: #9c27b0; }
        body { font-family: 'Segoe UI', å¾®è»Ÿæ­£é»‘é«”, sans-serif; margin: 0; background: var(--bg); }
        header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.2rem; }
        header a { color: white; text-decoration: none; font-size: 0.9rem; border: 1px solid white; padding: 5px 10px; border-radius: 4px; }
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .form-group { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; width: 100%; }
        .admin-flex-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; }
        .admin-flex-row div { flex: 1; min-width: 100px; }
        .admin-flex-row label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .btn { padding: 10px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        .btn-blue { background: var(--primary); width: 100%; margin-top: 10px; }
        .btn-update { background: var(--green); height: 42px; width: 100%; }
        .btn-logout { background: var(--gray); height: 42px; width: 100%; }
        .btn-danger-text { background: var(--accent); font-size: 12px; width: 100%; margin-top: 15px; }
        .btn-paid { background: var(--green); font-size: 11px; margin-top: 5px; width: 100%; }
        .btn-del { position: absolute; top: -8px; right: -8px; background: #333; color: white; border-radius: 50%; width: 22px; height: 22px; padding: 0; font-size: 12px; display: flex; align-items: center; justify-content: center; z-index: 10; cursor: pointer; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 10px; }
        .card { background: white; padding: 12px; border-radius: 8px; border: 1px solid #eee; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.3s; }
        .card.paid { border-bottom: 4px solid var(--green); }
        .card.absent { background: #eceff1; color: #90a4ae; border-style: dashed; }
        .card.waitlist { border-left: 4px solid var(--wait); background: #f3e5f5; }
        .card.loading { opacity: 0.6; filter: grayscale(1); pointer-events: none; transform: scale(0.98); }
        .card b { font-size: 16px; display: block; margin-bottom: 5px; }
        .status-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; }
        .num-tag { position: absolute; top: 5px; right: 25px; color: var(--primary); font-size: 12px; font-weight: bold; }
        .wait-tag { position: absolute; top: 5px; right: 25px; color: var(--wait); font-size: 12px; font-weight: bold; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div id="loading">è™•ç†ä¸­...</div>
<header>
    <h1>âš™ï¸ é–‹åœ˜ç®¡ç†</h1>
    <a href="index.html">å›å ±åé¦–é  ></a>
</header>

<div class="container">
    <div id="loginArea" class="form-group">
        <h3>ç®¡ç†å“¡ç™»å…¥</h3>
        <input type="password" id="verifyCode" placeholder="è«‹è¼¸å…¥é©—è­‰ç¢¼">
        <button class="btn btn-blue" onclick="login()">ç™»å…¥</button>
    </div>

    <div id="adminPanel" style="display:none;">
        <div class="form-group">
            <div class="admin-flex-row">
                <div><label>é–‹åœ˜æ—¥æœŸ</label><input type="date" id="groupDate"></div>
                <div><label>è²»ç”¨</label><input type="number" id="groupFee"></div>
            </div>
            <div class="admin-flex-row" style="margin-top:10px">
                <div><label>æ­£å–äººæ•¸</label><input type="number" id="groupMax"></div>
                <div><label>å€™è£œäººæ•¸</label><input type="number" id="groupWait"></div>
            </div>
            <div class="admin-flex-row" style="margin-top:10px;">
                <button class="btn btn-update" onclick="updateGroup()">æ›´æ–°è¨­å®š</button>
                <button class="btn btn-logout" onclick="logout()">ç™»å‡º</button>
            </div>
            <button class="btn btn-danger-text" onclick="clearData()">âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
        
        <div class="form-group">
            <h3>æ”¶è²»èˆ‡åå–®ç®¡ç†</h3>
            <div style="font-size:14px; margin-bottom:10px; color:#666;">ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—éè£œé †åºã€‚</div>
            <div id="adminCards" class="card-grid"></div>
        </div>
    </div>
</div>

<script>
// ==========================================
// âš ï¸ è«‹å¡«å…¥æ‚¨çš„ GAS ç¶²å€
// ==========================================
const GAS_URL = "https://script.google.com/macros/s/AKfycbyqp2GouSzUy3MFbSAVKxMQEVzJds9Ooo8cxd5dZj_0K3yR4_VrGsCGOv2ftN6dWgJF/exec"; 

let groupData = { participants: [] };

window.onload = async () => {
    await loadData();
    if (localStorage.getItem("adminLoggedIn") === "true") showAdminPanel();
}

async function sendRequest(params) {
    const loader = document.getElementById("loading");
    loader.style.display = "flex";
    try {
        const response = await fetch(`${GAS_URL}?${params}`);
        if (!response.ok) throw new Error("ç¶²è·¯éŒ¯èª¤");
        const result = await response.json();
        if (result.success === false) alert(result.message || "ç™¼ç”ŸéŒ¯èª¤");
        else if (result.participants) {
            groupData = result;
            if(localStorage.getItem("adminLoggedIn") === "true") renderCards(groupData.participants);
        }
        return result;
    } catch (e) {
        alert("é€£ç·šä¸ç©©å®šï¼Œè«‹é‡è©¦ã€‚\n" + e.message);
    } finally {
        loader.style.display = "none";
    }
}

async function loadData() { await sendRequest("action=get"); }

function login() {
    if(document.getElementById("verifyCode").value == groupData.verifyCode) {
        localStorage.setItem("adminLoggedIn", "true");
        showAdminPanel();
    } else { alert("é©—è­‰ç¢¼éŒ¯èª¤"); }
}

function showAdminPanel() {
    document.getElementById("loginArea").style.display="none";
    document.getElementById("adminPanel").style.display="block";
    if(groupData.date) document.getElementById("groupDate").value = groupData.date;
    document.getElementById("groupFee").value = groupData.fee;
    document.getElementById("groupMax").value = groupData.maxPeople;
    document.getElementById("groupWait").value = groupData.maxWaitlist || 0;
    renderCards(groupData.participants);
}

function logout() {
    if(confirm("ç¢ºå®šè¦ç™»å‡ºç®¡ç†æ¨¡å¼å—ï¼Ÿ")) {
        localStorage.removeItem("adminLoggedIn");
        location.reload();
    }
}

function renderCards(data) {
    const container = document.getElementById("adminCards");
    container.innerHTML = "";
    data.forEach(row => {
        const name = row[1];
        const status = row[2];
        const isPaid = row[4] === "å·²ç¹³è²»";
        const isAbsent = row[5] === "è«‹å‡";
        const isWait = status === "å€™è£œ";
        
        const card = document.createElement("div");
        card.id = `card-${name}`;
        card.className = `card ${isPaid ? 'paid' : ''} ${isAbsent ? 'absent' : ''} ${isWait && !isAbsent ? 'waitlist' : ''}`;
        
        // é¡¯ç¤ºç·¨è™Ÿ
        let infoHtml = "";
        if (!isAbsent) {
            infoHtml = isWait ? `<span class="wait-tag">å€™è£œ</span>` : `<span class="num-tag">#${status}</span>`;
        }

        let html = `<b>${name}</b>${infoHtml}`;
        html += `<span class="status-tag">${isAbsent ? 'å·²è«‹å‡' : (isPaid ? 'å·²ç¹³è²»' : 'æœªç¹³è²»')}</span>`;
        html += `<div class="btn-del" onclick="handleAction('delete', '${name}')">âœ•</div>`;
        if(!isPaid && !isAbsent) html += `<button class="btn btn-paid" onclick="handleAction('paid', '${name}')">æ¨™è¨˜ç¹³è²»</button>`;
        
        card.innerHTML = html;
        container.appendChild(card);
    });
}

async function handleAction(action, name) {
    if(action === 'delete' && !confirm(`ç¢ºå®šå¾¹åº•åˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
    document.getElementById(`card-${name}`).classList.add("loading");
    await sendRequest(`action=${action}&name=${encodeURIComponent(name)}`);
}

function updateGroup() {
    const date = document.getElementById("groupDate").value;
    const fee = document.getElementById("groupFee").value;
    const max = document.getElementById("groupMax").value;
    const wait = document.getElementById("groupWait").value;
    
    if(!date || !fee || !max) { alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½"); return; }
    sendRequest(`action=update&date=${date}&fee=${fee}&max=${max}&wait=${wait}`).then(() => alert("è¨­å®šå·²æ›´æ–°"));
}

function clearData() {
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å ±ååˆ—å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) sendRequest(`action=clear`);
}
</script>
</body>
</html>
