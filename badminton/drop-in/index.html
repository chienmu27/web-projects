<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¾½çƒè‡¨æ‰“å ±åç³»çµ±</title>

<style>
body{
  font-family: Arial;
  margin:0;
  background:#f2f2f2;
}

header{
  background:#1976d2;
  color:white;
  padding:15px;
  text-align:center;
}

.tabs{
  display:flex;
}

.tabs button{
  flex:1;
  padding:12px;
  border:none;
  background:#ddd;
  cursor:pointer;
}

.tabs button.active{
  background:#1976d2;
  color:white;
}

.section{
  display:none;
  padding:20px;
}

.section.active{
  display:block;
}

.card{
  background:white;
  padding:15px;
  margin:10px 0;
  border-radius:8px;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
  cursor:pointer;
}

.paid{
  background:#d4edda;
}
</style>
</head>

<body>

<header>
  ğŸ¸ ç¾½çƒè‡¨æ‰“å ±åç³»çµ±
</header>

<div class="tabs">
  <button onclick="switchTab('signup')" class="active">è‡¨æ‰“å ±å</button>
  <button onclick="switchTab('admin')">é–‹åœ˜ç®¡ç†</button>
</div>

<!-- ================= è‡¨æ‰“å ±å ================= -->
<div id="signup" class="section active">

<h3>åƒåŠ è€…å§“å</h3>
<input type="text" id="username" placeholder="è«‹è¼¸å…¥å§“å">
<button onclick="saveName()">å„²å­˜å§“å</button>

<h3>ç›®å‰é–‹åœ˜</h3>
<div id="groupInfo"></div>

<button onclick="join()">é€å‡ºåƒåŠ </button>

<h3>å ±ååå–®</h3>
<div id="signupCards"></div>

</div>

<!-- ================= é–‹åœ˜ç®¡ç† ================= -->
<div id="admin" class="section">

<div id="loginArea">
  <h3>ç®¡ç†ç™»å…¥</h3>
  <input type="password" id="verifyCode" placeholder="è¼¸å…¥é©—è­‰ç¢¼">
  <button onclick="login()">ç™»å…¥</button>
</div>

<div id="adminPanel" style="display:none;">

  <h3>é–‹åœ˜è¨­å®š</h3>
  æ—¥æœŸï¼š<input type="date" id="groupDate"><br><br>
  è²»ç”¨ï¼š<input type="number" id="groupFee"><br><br>
  äººæ•¸ï¼š<input type="number" id="groupMax"><br><br>
  <button onclick="updateGroup()">é€å‡º</button>

  <h3>å ±ååå–®</h3>
  <div id="adminCards"></div>

</div>

</div>

<script>

// ===== ä¿®æ”¹æˆä½ çš„ GAS ç¶²å€ =====
const GAS_URL = "https://script.google.com/macros/s/AKfycbx9llvBGQUOdphtJxjlqPfJuQhwKqT7_X3Xtn2S78BWka-Aao-188W7bAiR3Ft8msEqzA/exec";

let groupData = {};

function switchTab(tab){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  
  document.getElementById(tab).classList.add("active");
  event.target.classList.add("active");
}

// å„²å­˜å§“å
function saveName(){
  const name = document.getElementById("username").value;
  localStorage.setItem("badmintonName", name);
  alert("å§“åå·²å„²å­˜");
}

// è¼‰å…¥å§“å
window.onload = function(){
  const name = localStorage.getItem("badmintonName");
  if(name) document.getElementById("username").value = name;
  loadData();
}

function loadData(){
  fetch(GAS_URL + "?action=get")
  .then(r=>r.json())
  .then(data=>{
    groupData = data;
    render();
  });
}

function render(){
  document.getElementById("groupInfo").innerHTML =
    `æ—¥æœŸï¼š${formatDate(groupData.date)}<br>
     è²»ç”¨ï¼š${groupData.fee} å…ƒ<br>
     äººæ•¸ï¼š${groupData.currentCount}/${groupData.maxPeople}`;
  
  renderCards(groupData.participants, "signupCards");
  renderCards(groupData.participants, "adminCards");
}

function renderCards(data, containerId){
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  
  data.forEach(row=>{
    const card = document.createElement("div");
    card.className = "card";
    if(row[3]=="å·²ç¹³è²»") card.classList.add("paid");
    
    card.innerHTML = `
      <b>${row[1]}</b><br>
      ${formatDate(row[0])}<br>
      ${row[2]} å…ƒ<br>
      ${row[3]||"æœªç¹³è²»"}
    `;
    
    card.onclick = ()=>{
      if(containerId=="adminCards"){
        fetch(GAS_URL + "?action=paid&name=" + row[1])
        .then(()=>loadData());
      }
    };
    
    container.appendChild(card);
  });
}

function join(){
  const name = document.getElementById("username").value;
  if(!name) return alert("è«‹è¼¸å…¥å§“å");
  
  fetch(GAS_URL + "?action=join&name=" + name)
  .then(r=>r.json())
  .then(res=>{
    if(!res.success) alert(res.message);
    loadData();
  });
}

function login(){
  if(document.getElementById("verifyCode").value == groupData.verifyCode){
    document.getElementById("loginArea").style.display="none";
    document.getElementById("adminPanel").style.display="block";
  }else{
    alert("é©—è­‰ç¢¼éŒ¯èª¤");
  }
}

function updateGroup(){
  const date = document.getElementById("groupDate").value;
  const fee = document.getElementById("groupFee").value;
  const max = document.getElementById("groupMax").value;
  
  fetch(`${GAS_URL}?action=update&date=${date}&fee=${fee}&max=${max}`)
  .then(()=>loadData());
}

function formatDate(d){
  const date = new Date(d);
  return (date.getMonth()+1)+"æœˆ"+date.getDate()+"æ—¥";
}

</script>

</body>
</html>
