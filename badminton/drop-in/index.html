<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¸ ç¾½çƒè‡¨æ‰“å ±åç³»çµ±</title>
    <style>
        :root { --primary: #1976d2; --bg: #f5f7fa; }
        body { font-family: 'Segoe UI', å¾®è»Ÿæ­£é»‘é«”, sans-serif; margin: 0; background: var(--bg); color: #333; }
        header { background: var(--primary); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .tabs { display: flex; background: #e0e0e0; position: sticky; top: 0; z-index: 100; }
        .tabs button { flex: 1; padding: 15px; border: none; background: none; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .tabs button.active { background: white; color: var(--primary); font-weight: bold; border-bottom: 3px solid var(--primary); }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-group { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button.btn-main { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        button.btn-main:disabled { background: #ccc; }

        .info-board { background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 5px solid #ff9800; margin-bottom: 20px; }
        
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: white; padding: 15px; border-radius: 10px; border: 1px solid #eee; position: relative; transition: 0.2s; }
        .card.paid { background: #e8f5e9; border-color: #4caf50; }
        .card.paid::after { content: "âœ“ å·²ç¹³è²»"; position: absolute; top: 5px; right: 8px; font-size: 12px; color: #2e7d32; font-weight: bold; }
        .card b { font-size: 18px; color: var(--primary); }
        .admin-mode .card { cursor: pointer; }
        .admin-mode .card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:999; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">è®€å–ä¸­...</div>

<header>
    <h2>ğŸ¸ ç¾½çƒè‡¨æ‰“å ±å</h2>
</header>

<div class="tabs">
    <button id="tab-signup" onclick="switchTab('signup')" class="active">è‡¨æ‰“å ±å</button>
    <button id="tab-admin" onclick="switchTab('admin')">é–‹åœ˜ç®¡ç†</button>
</div>

<div class="container">
    <div id="signup" class="section active">
        <div class="form-group">
            <label>ä½ çš„å¤§åï¼š</label>
            <input type="text" id="username" placeholder="è«‹è¼¸å…¥å§“å" onchange="saveName()">
            <small style="color: #666;">* å§“åæœƒè‡ªå‹•å„²å­˜ï¼Œä¸‹æ¬¡å…å¡«</small>
        </div>

        <div id="infoArea" class="info-board">è®€å–é–‹åœ˜è³‡è¨Šä¸­...</div>

        <button id="joinBtn" class="btn-main" onclick="join()">ç¢ºèªå ±åé€å‡º</button>

        <h3 style="margin-top:30px;">ç›®å‰å ±ååå–®</h3>
        <div id="signupCards" class="card-grid"></div>
    </div>

    <div id="admin" class="section">
        <div id="loginArea" class="form-group">
            <h3>ç®¡ç†å“¡ç™»å…¥</h3>
            <input type="password" id="verifyCode" placeholder="è«‹è¼¸å…¥å·¥ä½œè¡¨H2çš„é©—è­‰ç¢¼">
            <button class="btn-main" onclick="login()">ç™»å…¥ç®¡ç†ä»‹é¢</button>
        </div>

        <div id="adminPanel" style="display:none;">
            <div class="form-group">
                <h3>é–‹åœ˜è¨­å®š</h3>
                æ—¥æœŸï¼š<input type="date" id="groupDate">
                è²»ç”¨ï¼š<input type="number" id="groupFee" placeholder="æ¯äººè²»ç”¨">
                äººæ•¸ä¸Šé™ï¼š<input type="number" id="groupMax" placeholder="ä¸Šé™äººæ•¸">
                <button class="btn-main" onclick="updateGroup()">æ›´æ–°é–‹åœ˜è³‡è¨Š</button>
            </div>

            <div class="form-group admin-mode">
                <h3>æ”¶è²»ç®¡ç† (é»æ“Šå¡ç‰‡æ¨™è¨˜å·²ç¹³è²»)</h3>
                <div id="adminCards" class="card-grid"></div>
            </div>
        </div>
    </div>
</div>

<script>
// !!! è«‹å‹™å¿…æ›¿æ›æˆä½ éƒ¨ç½²å¾Œçš„ GAS ç¶²å€ !!!
const GAS_URL = "https://script.google.com/macros/s/AKfycbyCSZR1QM7xcVQ3zjtc4xXNc8IYkrR0OO85tgRdQl-YLyhhLTnBJ_zClhtG-hnK5uwQ/exec"; 

let groupData = { participants: [] };

// åˆ‡æ›åˆ†é 
function switchTab(tab){
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
    document.getElementById(tab).classList.add("active");
    document.getElementById('tab-' + tab).classList.add("active");
}

// å„²å­˜å§“ååˆ°ç€è¦½å™¨
function saveName(){
    const name = document.getElementById("username").value;
    localStorage.setItem("badmintonName", name);
}

window.onload = function(){
    const name = localStorage.getItem("badmintonName");
    if(name) document.getElementById("username").value = name;
    loadData();
}

function showLoading(show) {
    document.getElementById("loading").style.display = show ? "flex" : "none";
}

// è®€å–è³‡æ–™
function loadData(){
    showLoading(true);
    fetch(`${GAS_URL}?action=get`)
    .then(r => r.json())
    .then(data => {
        groupData = data;
        render();
        showLoading(false);
    }).catch(e => alert("é€£ç·šéŒ¯èª¤ï¼š" + e));
}

function render(){
    // æ›´æ–°è³‡è¨Šçœ‹æ¿
    const dateObj = new Date(groupData.date);
    const dateStr = groupData.date ? `${dateObj.getMonth()+1}æœˆ${dateObj.getDate()}æ—¥` : "æœªå®š";
    
    document.getElementById("infoArea").innerHTML = `
        <b>ğŸ“… é–‹åœ˜æ—¥æœŸï¼š</b>${dateStr}<br>
        <b>ğŸ’° å ±åè²»ç”¨ï¼š</b>${groupData.fee} å…ƒ<br>
        <b>ğŸ‘¥ å ±åäººæ•¸ï¼š</b>${groupData.currentCount} / ${groupData.maxPeople}
    `;

    // åˆ¤æ–·æ˜¯å¦é¡æ»¿
    const joinBtn = document.getElementById("joinBtn");
    if(groupData.currentCount >= groupData.maxPeople) {
        joinBtn.disabled = true;
        joinBtn.innerText = "å·²é¡æ»¿ï¼Œåœæ­¢å ±å";
    } else {
        joinBtn.disabled = false;
        joinBtn.innerText = "ç¢ºèªå ±åé€å‡º";
    }

    renderCards(groupData.participants, "signupCards", false);
    renderCards(groupData.participants, "adminCards", true);
}

function renderCards(data, containerId, isAdmin){
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    
    data.forEach(row => {
        const isPaid = row[3] === "å·²ç¹³è²»";
        const card = document.createElement("div");
        card.className = `card ${isPaid ? 'paid' : ''}`;
        
        const dateObj = new Date(row[0]);
        const shortDate = `${dateObj.getMonth()+1}/${dateObj.getDate()}`;

        card.innerHTML = `
            <b>${row[1]}</b><br>
            <small>${shortDate} | ${row[2]}å…ƒ</small>
        `;
        
        if(isAdmin && !isPaid){
            card.onclick = () => {
                if(confirm(`ç¢ºèª ${row[1]} å·²ç¹³è²»ï¼Ÿ`)){
                    showLoading(true);
                    fetch(`${GAS_URL}?action=paid&name=${encodeURIComponent(row[1])}`)
                    .then(() => loadData());
                }
            };
        }
        container.appendChild(card);
    });
}

function join(){
    const name = document.getElementById("username").value.trim();
    if(!name) return alert("è«‹è¼¸å…¥å§“å");
    
    showLoading(true);
    fetch(`${GAS_URL}?action=join&name=${encodeURIComponent(name)}`)
    .then(r => r.json())
    .then(res => {
        if(!res.success) alert(res.message);
        loadData();
    });
}

function login(){
    const inputCode = document.getElementById("verifyCode").value;
    if(inputCode == groupData.verifyCode){
        document.getElementById("loginArea").style.display="none";
        document.getElementById("adminPanel").style.display="block";
        // é å¡«ç›®å‰è¨­å®š
        if(groupData.date) {
            const d = new Date(groupData.date);
            document.getElementById("groupDate").value = d.toISOString().split('T')[0];
        }
        document.getElementById("groupFee").value = groupData.fee;
        document.getElementById("groupMax").value = groupData.maxPeople;
    } else {
        alert("é©—è­‰ç¢¼éŒ¯èª¤ï¼è«‹æŸ¥çœ‹è©¦ç®—è¡¨ H2 å„²å­˜æ ¼");
    }
}

function updateGroup(){
    const date = document.getElementById("groupDate").value;
    const fee = document.getElementById("groupFee").value;
    const max = document.getElementById("groupMax").value;
    
    showLoading(true);
    fetch(`${GAS_URL}?action=update&date=${date}&fee=${fee}&max=${max}`)
    .then(() => {
        alert("è¨­å®šå·²æ›´æ–°");
        loadData();
    });
}
</script>

</body>
</html>
