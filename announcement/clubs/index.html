<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東海國小114下社團報名結果公告</title>

    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 15px; }
        
        #announcement { 
            color: #0056b3; 
            font-weight: bold; 
            font-size: 1em; 
            margin-bottom: 20px; 
            white-space: pre-wrap; 
            line-height: 1.6;
            column-count: 2;
            column-gap: 40px;
            column-rule: 1px dashed #d1e3f8;
            text-align: left;
        }

        @media (max-width: 600px) {
            #announcement { column-count: 1; }
        }

        .controls { margin-bottom: 20px; background: #e9ecef; padding: 20px; border-radius: 8px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        select { width: 100%; padding: 12px; font-size: 16px; border-radius: 5px; border: 1px solid #ced4da; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
        th, td { border: 1px solid #dee2e6; padding: 12px 8px; text-align: center; }
        th { background: #2c3e50; color: white; white-space: nowrap; }
        tr:nth-child(even) { background: #f8f9fa; }
        .no-data { text-align: center; padding: 40px; color: #6c757d; font-size: 18px; line-height: 1.6; }
        .status-pass { color: #28a745; font-weight: bold; }
        .timer-info { text-align: center; font-size: 0.9em; color: #888; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 10px; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>

<div class="container">
    <h1>東海國小114下社團報名結果</h1>
    
    <div id="announcement">正在載入公告內容...</div>
    
    <div id="mainContent">
        <div class="controls">
            <label for="clubSelect">請選擇社團名稱：</label>
            <select id="clubSelect" disabled>
                <option value="">檢查公告時間中...</option>
            </select>
        </div>

        <div id="resultArea" class="table-responsive">
            <div class="no-data">請先從上方選單選擇社團</div>
        </div>
    </div>

    <div id="timeMessage" style="display:none;"></div>
    <div class="timer-info" id="timerInfo"></div>
</div>

<script>
    const config = {
        start: { y: 2026, m: 2, d: 26, hr: 18, min: 0 }, 
        end:   { y: 2026, m: 3, d: 6, hr: 17, min: 0 },
        csvURL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIzS-_hGz-62j8Ky4aUuJSpeaPTjSHOx85BGfjowRx4-wQQS6gk4ulyNI8GjD1SPhrQLeQpuVtOR9o/pub?gid=0&single=true&output=csv"
    };

    const startTime = new Date(config.start.y, config.start.m - 1, config.start.d, config.start.hr, config.start.min);
    const endTime = new Date(config.end.y, config.end.m - 1, config.end.d, config.end.hr, config.end.min);

    function formatTimeDisplay(dateObj) {
        const y = dateObj.getFullYear();
        const m = dateObj.getMonth() + 1;
        const d = dateObj.getDate();
        const hr = String(dateObj.getHours()).padStart(2, '0');
        const min = String(dateObj.getMinutes()).padStart(2, '0');
        return `${y}/${m}/${d} ${hr}:${min}`;
    }

    function checkTimeAndInit() {
        const now = new Date();
        const mainContent = document.getElementById("mainContent");
        const timeMessage = document.getElementById("timeMessage");
        const timerInfo = document.getElementById("timerInfo");
        const announcementDiv = document.getElementById("announcement");

        const displayStart = formatTimeDisplay(startTime);
        const displayEnd = formatTimeDisplay(endTime);

        timerInfo.innerHTML = `公告查詢期間：${displayStart} ~ ${displayEnd}`;

        if (now < startTime) {
            mainContent.style.display = "none";
            announcementDiv.style.display = "none";
            timeMessage.style.display = "block";
            timeMessage.innerHTML = `<div class="no-data">目前尚未開放查詢。<br>公告開始時間：${displayStart}</div>`;
        } else if (now > endTime) {
            mainContent.style.display = "none";
            announcementDiv.style.display = "none";
            timeMessage.style.display = "block";
            timeMessage.innerHTML = `<div class="no-data">公告查詢期限已過 (${displayEnd})。<br>如有疑問請洽本校教務處。</div>`;
        } else {
            loadData();
        }
    }

    let allData = [];
    let validHeaders = []; // 用來存儲有標題名稱的欄位

    function loadData() {
        Papa.parse(config.csvURL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                allData = results.data;
                
                if (allData.length > 0) {
                    // 1. 處理公告內容
                    const info = allData[0]["公告說明"] || "歡迎查詢社團報名結果";
                    document.getElementById("announcement").textContent = info;

                    // 2. 動態偵測有效欄位 (排除空白標題與公告說明)
                    // 取得第一行所有的 key (標題)
                    const rawHeaders = Object.keys(allData[0]);
                    validHeaders = rawHeaders.filter(h => {
                        // 排除自動生成的 "_數字"、空白標題、以及功能性的 "公告說明"
                        return h.trim() !== "" && !h.startsWith("__parsed_extra") && !h.startsWith("_") && h !== "公告說明";
                    });
                }
                renderClubOptions();
            },
            error: function() {
                document.getElementById("resultArea").innerHTML = "<div class='no-data' style='color:red;'>資料讀取失敗。</div>";
                document.getElementById("announcement").textContent = "無法載入公告內容";
            }
        });
    }

    function renderClubOptions() {
        const clubSelect = document.getElementById("clubSelect");
        const clubs = [...new Set(allData.map(item => item["社團名稱"]))].filter(c => c).sort();
        clubSelect.innerHTML = '<option value="">-- 請選擇社團 --</option>';
        clubs.forEach(club => {
            const option = document.createElement("option");
            option.value = club;
            option.textContent = club;
            clubSelect.appendChild(option);
        });
        clubSelect.disabled = false;
    }

    function maskName(name) {
        if (!name || name.includes("○")) return name;
        if (name.length <= 1) return name;
        if (name.length === 2) return name[0] + "○";
        return name[0] + "○" + name.substring(2);
    }

    document.getElementById("clubSelect").addEventListener("change", function() {
        const selectedClub = this.value;
        const resultArea = document.getElementById("resultArea");
        if (!selectedClub) {
            resultArea.innerHTML = '<div class="no-data">請先從上方選單選擇社團</div>';
            return;
        }

        const filtered = allData.filter(row => row["社團名稱"] === selectedClub);
        
        // --- 動態生成表格 ---
        let tableHtml = `<table><thead><tr>`;
        
        // 生成有資料的標題列
        validHeaders.forEach(header => {
            // 修正顯示名稱：將長標題簡化顯示或保持原樣
            let displayHeader = header.includes("姓名") ? "姓名" : header;
            tableHtml += `<th>${displayHeader}</th>`;
        });
        tableHtml += `</tr></thead><tbody>`;
        
        // 生成內容列
        filtered.forEach(row => {
            tableHtml += `<tr>`;
            validHeaders.forEach(header => {
                let cellData = row[header] || "";
                
                // 特殊處理：姓名遮罩
                if (header.includes("姓名")) {
                    cellData = maskName(cellData);
                }
                
                // 特殊處理：錄取狀態顏色
                let tdClass = (header === "報名結果" && cellData.includes('錄取')) ? 'class="status-pass"' : '';
                
                tableHtml += `<td ${tdClass}>${cellData}</td>`;
            });
            tableHtml += `</tr>`;
        });
        
        tableHtml += '</tbody></table>';
        resultArea.innerHTML = tableHtml;
    });

    checkTimeAndInit();
</script>

</body>
</html>
