<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理後台</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.nav-btn{padding:6px 14px;border-radius:8px}
.nav-btn.active{background:white;color:#dc2626;font-weight:bold}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:50}
.modal{background:white;padding:20px;border-radius:12px;min-width:300px}
</style>
</head>
<body class="bg-gray-100">

<script>
const GAS_API_URL="https://script.google.com/macros/s/AKfycbzM-6pQIXi_j2sBTxEFmh206BvPiLonWds-u25yQshpkOqLIuGfzBFFwn73_27WuDxT/exec";
let PASSWORD="";
</script>

<!-- 登入 -->
<div id="login" class="fixed inset-0 bg-red-600 flex items-center justify-center">
<div class="bg-white p-8 rounded-2xl w-80">
<h2 class="text-xl font-bold text-center mb-4">管理登入</h2>
<input id="pwd" type="password" class="w-full border p-2 mb-4 rounded" onkeypress="if(event.key==='Enter'){login();}">
<button onclick="login()" class="w-full bg-red-600 text-white p-2 rounded">登入</button>
<div id="msg" class="text-red-500 text-center mt-2"></div>
</div>
</div>

<div id="admin" class="hidden">

<header class="bg-red-600 text-white p-4 flex justify-between">
<h1>管理後台</h1>
<div>
<button id="btn-history" onclick="switchTab('history')" class="nav-btn active">訂單</button>
<button id="btn-menu" onclick="switchTab('menu')" class="nav-btn">菜單</button>
</div>
</header>

<div class="p-6">

<section id="history">
<table class="w-full bg-white shadow rounded">
<thead class="bg-gray-200">
<tr>
<th>日期時間</th>
<th>品項</th>
<th>單價</th>
<th>數量</th>
<th>小計</th>
<th>桌號</th>
<th>已送餐</th>
<th>操作</th>
</tr>
</thead>
<tbody id="orderBody"></tbody>
</table>
</section>

<section id="menu" class="hidden">
<button onclick="addMenu()" class="mb-3 bg-green-600 text-white px-3 py-1 rounded" onkeypress="if(event.key==='Enter'){addMenu();}">新增</button>
<table class="w-full bg-white shadow rounded">
<thead class="bg-gray-200">
<tr><th>分類</th><th>名稱</th><th>描述</th><th>價格</th><th>操作</th></tr>
</thead>
<tbody id="menuBody"></tbody>
</table>
</section>

</div>
</div>

<!-- 編輯彈窗 -->
<div id="editModal" class="modal-bg hidden">
<div class="modal">
<h3 class="text-lg font-bold mb-2">編輯菜單</h3>
<table class="w-full mb-3">
<tr><td>分類</td><td><input id="modalCategory" class="border p-1 w-full"></td></tr>
<tr><td>名稱</td><td><input id="modalName" class="border p-1 w-full"></td></tr>
<tr><td>描述</td><td><input id="modalDesc" class="border p-1 w-full"></td></tr>
<tr><td>價格</td><td><input id="modalPrice" type="number" class="border p-1 w-full"></td></tr>
</table>
<div class="flex justify-end gap-2">
<button onclick="confirmEdit()" class="bg-green-600 text-white px-3 py-1 rounded">確認</button>
<button onclick="cancelEdit()" class="bg-gray-400 text-white px-3 py-1 rounded">取消</button>
</div>
</div>
</div>

<script>
let editRow = null;

// API
async function api(payload){
  payload.password = PASSWORD;
  const res = await fetch(GAS_API_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain"},
    body:JSON.stringify(payload)
  });
  return await res.json();
}

// 登入
async function login(){
  PASSWORD=document.getElementById("pwd").value;
  const res=await api({action:"adminLogin"});
  if(res.ok){
    document.getElementById("login").classList.add("hidden");
    document.getElementById("admin").classList.remove("hidden");
    loadOrders();
  }else{
    document.getElementById("msg").innerText="密碼錯誤";
  }
}

// 分頁切換
function switchTab(tab){
  document.getElementById("history").classList.add("hidden");
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("btn-history").classList.remove("active");
  document.getElementById("btn-menu").classList.remove("active");
  document.getElementById(tab).classList.remove("hidden");
  document.getElementById("btn-"+tab).classList.add("active");
  if(tab==="menu") loadMenu();
}

// 訂單
async function loadOrders(){
  const res=await api({action:"getOrderHistory"});
  if(!res.ok){alert("訂單讀取失敗");return;}
  document.getElementById("orderBody").innerHTML=res.data.map(r=>`
<tr>
<td>${new Date(r.time).toLocaleString()}</td>
<td>${r.name}</td>
<td>${r.price}</td>
<td>${r.qty}</td>
<td>${r.subtotal}</td>
<td>${r.table}</td>
<td>${r.status}</td>
<td><button class="bg-red-500 text-white px-2 py-1 rounded" onclick="deleteOrder(${r.row})">刪除</button></td>
</tr>`).join("");
}

async function deleteOrder(row){
  if(!confirm("確定刪除此訂單?")) return;
  await api({action:"deleteOrder",row});
  loadOrders();
}

// 菜單
async function loadMenu(){
  const res=await api({action:"getMenu"});
  if(!res.ok){alert("菜單讀取失敗");return;}
  document.getElementById("menuBody").innerHTML=res.data.map(m=>`
<tr>
<td>${m.category}</td>
<td>${m.name}</td>
<td>${m.desc}</td>
<td>${m.price}</td>
<td>
<button onclick="showEditModal(${m.row},'${m.category}','${m.name}','${m.desc}',${m.price})" class="bg-yellow-500 text-white px-2 py-1 rounded">編輯</button>
<button onclick="deleteMenu(${m.row})" class="bg-red-500 text-white px-2 py-1 rounded">刪除</button>
</td>
</tr>`).join("");
}

function addMenu(){showEditModal(null,"","","",0);}

function showEditModal(row,category,name,desc,price){
  editRow=row;
  document.getElementById("modalCategory").value=category;
  document.getElementById("modalName").value=name;
  document.getElementById("modalDesc").value=desc;
  document.getElementById("modalPrice").value=price;
  document.getElementById("editModal").classList.remove("hidden");
}

// 確認編輯
async function confirmEdit(){
  const category=document.getElementById("modalCategory").value;
  const name=document.getElementById("modalName").value;
  const desc=document.getElementById("modalDesc").value;
  const price=document.getElementById("modalPrice").value;
  if(editRow){
    await api({action:"editMenuItem",row:editRow,category,name,desc,price});
  }else{
    await api({action:"addMenuItem",category,name,desc,price});
  }
  cancelEdit();
  loadMenu();
}

// 取消編輯
function cancelEdit(){
  document.getElementById("editModal").classList.add("hidden");
}

// 刪除菜單
async function deleteMenu(row){
  if(!confirm("確定刪除?"))return;
  await api({action:"deleteMenuItem",row});
  loadMenu();
}

// 支援 ENTER
document.addEventListener("keypress",function(e){
  if(e.key==="Enter"){
    const activeEl=document.activeElement;
    if(activeEl.id==="pwd") login();
    if(document.getElementById("editModal").classList.contains("hidden")==false) confirmEdit();
  }
});
</script>
</body>
</html>
