<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å­¸ç”Ÿè¨‚é¤ç³»çµ±</title>
<style>
  body { font-family: "Microsoft JhengHei", sans-serif; padding: 0; margin: 0; background: #fafafa; }
  
  /* åˆ†é æŒ‰éˆ•æ¨£å¼ */
  .tabs { display: flex; background: #333; }
  .tab-btn { 
    flex: 1; padding: 15px; border: none; background: #333; color: white; 
    cursor: pointer; font-size: 16px; transition: 0.3s;
  }
  .tab-btn:hover { background: #555; }
  .tab-btn.active { background: #007bff; font-weight: bold; }

  /* å…§å®¹å€åŸŸ */
  .content { display: none; padding: 20px; }
  .content.active { display: block; }

  /* è¡¨å–®å®¹å™¨ */
  .iframe-container { width: 100%; height: 800px; border: none; }

  /* æŸ¥è©¢é é¢æ¨£å¼ */
  h2 { color: #333; margin-top: 0; }
  select { font-size: 16px; padding: 6px; margin: 10px 0; width: 200px; border-radius: 4px; border: 1px solid #ccc; }
  table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  th, td { border: 1px solid #eee; padding: 12px; text-align: center; font-size: 15px; }
  th { background-color: #f8f9fa; color: #555; }

  #countInline {
    display: inline-block;
    margin-left: 12px;
    font-size: 15px;
    font-weight: bold;
    color: #007bff;
  }
  .controls { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
</style>
</head>
<body>

<div class="tabs">
  <button class="tab-btn active" onclick="openTab('form-tab', this)">æˆ‘è¦è¨‚é¤</button>
  <button class="tab-btn" onclick="openTab('search-tab', this)">è¨‚é¤æŸ¥è©¢</button>
</div>

<div id="form-tab" class="content active">
  <iframe class="iframe-container" src="https://docs.google.com/forms/d/e/1FAIpQLSdO7i6Y_YgYhD0mS0-P8m3TshvI_UonD78F_C0S8zYyV_1B_A/viewform?embedded=true">è¼‰å…¥ä¸­â€¦</iframe>
</div>

<div id="search-tab" class="content">
  <div class="controls">
    <h2>è¨‚é¤ç´€éŒ„æŸ¥è©¢</h2>
    <label>é¸æ“‡æ—¥æœŸï¼š</label>
    <select id="dateSelect">
      <option value="">--è«‹è¼‰å…¥ä¸­--</option>
    </select>
    <span id="countInline"></span>
    <br>
    <label>é¸æ“‡å­¸ç”Ÿï¼š</label>
    <select id="studentSelect">
      <option value="">--è«‹è¼‰å…¥ä¸­--</option>
    </select>
  </div>

  <table id="resultTable">
    <thead>
      <tr><th>è¨‚é¤æ—¥æœŸ</th><th>å­¸ç”Ÿå§“å</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
// æ³¨æ„ï¼šæ­¤è™•éœ€æ›´æ›ç‚ºæ‚¨è©¦ç®—è¡¨ã€Œè¡¨å–®å›æ‡‰ 1ã€å·¥ä½œè¡¨çš„ CSV ç™¼ä½ˆé€£çµ
// ç´¢å¼•ï¼šGæ¬„ç‚º r[6], Hæ¬„ç‚º r[7]
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUnpp7ywdL_MDPC4l8_qcehjnmmm3ZcihJfbNkAPr8-g7gkigalKEH7Dsebg5pc0xrXHwRjOayo8iy/pub?gid=1115559903&single=true&output=csv";

let rows = [];

// åˆ†é åˆ‡æ›å‡½å¼
function openTab(tabId, btn) {
  const contents = document.querySelectorAll('.content');
  const buttons = document.querySelectorAll('.tab-btn');
  
  contents.forEach(c => c.classList.remove('active'));
  buttons.forEach(b => b.classList.remove('active'));
  
  document.getElementById(tabId).classList.add('active');
  btn.classList.add('active');

  // å¦‚æœåˆ‡æ›åˆ°æŸ¥è©¢é ï¼Œé‡æ–°æŠ“å–æœ€æ–°è³‡æ–™
  if(tabId === 'search-tab') loadCSV();
}

// è§£æ CSV
function parseCSV(text) {
  const result = [];
  let cur = [], curVal = "", inQuotes = false;
  const lines = text.split(/\r?\n/);
  
  lines.forEach(line => {
    let cells = [];
    let cell = "";
    let insideQuote = false;
    for (let i = 0; i < line.length; i++) {
      let char = line[i];
      if (char === '"' && line[i+1] === '"') { cell += '"'; i++; }
      else if (char === '"') { insideQuote = !insideQuote; }
      else if (char === ',' && !insideQuote) { cells.push(cell); cell = ""; }
      else { cell += char; }
    }
    cells.push(cell);
    result.push(cells);
  });
  return result;
}

// è¼‰å…¥è³‡æ–™
async function loadCSV() {
  try {
    const res = await fetch(csvUrl);
    const text = await res.text();
    rows = parseCSV(text).filter(r => r.length > 7); // ç¢ºä¿è‡³å°‘æœ‰åˆ° H æ¬„
    buildDropdowns();
  } catch (e) {
    console.error("è³‡æ–™è¼‰å…¥å¤±æ•—", e);
  }
}

// å»ºç«‹ä¸‹æ‹‰é¸å–® (Gæ¬„=ç´¢å¼•6, Hæ¬„=ç´¢å¼•7)
function buildDropdowns() {
  const dateSet = new Set(), studentSet = new Set();
  const dateSel = document.getElementById("dateSelect");
  const studentSel = document.getElementById("studentSelect");

  rows.forEach((r, i) => {
    if (i > 0) { // è·³éæ¨™é¡Œåˆ—
      if (r[6]) dateSet.add(r[6].trim());
      if (r[7]) studentSet.add(r[7].trim());
    }
  });

  const dates = Array.from(dateSet).sort((a, b) => new Date(b) - new Date(a));
  const students = Array.from(studentSet).sort();

  dateSel.innerHTML = '<option value="">--è«‹é¸æ“‡æ—¥æœŸ--</option>';
  studentSel.innerHTML = '<option value="">--è«‹é¸æ“‡å­¸ç”Ÿ--</option>';

  dates.forEach(d => dateSel.add(new Option(d, d)));
  students.forEach(s => studentSel.add(new Option(s, s)));
}

// ç¯©é¸èˆ‡æ¸²æŸ“
function runFilter() {
  const dateValue = document.getElementById("dateSelect").value;
  const studentValue = document.getElementById("studentSelect").value;
  const tbody = document.querySelector("#resultTable tbody");
  const countSpan = document.getElementById("countInline");
  
  const matches = rows.filter((r, i) => {
    if (i === 0) return false;
    const dMatch = !dateValue || r[6].trim() === dateValue;
    const sMatch = !studentValue || r[7].trim() === studentValue;
    return dMatch && sMatch;
  });

  // æ›´æ–°äººæ•¸çµ±è¨ˆï¼ˆåƒ…è¨ˆç®—é¸ä¸­æ—¥æœŸçš„ä¸é‡è¤‡å­¸ç”Ÿï¼‰
  if (dateValue) {
    const studentCount = new Set(matches.map(r => r[7].trim())).size;
    countSpan.textContent = `ğŸ“Œ è©²æ—¥è¨‚é¤äººæ•¸ï¼š${studentCount} äºº`;
  } else {
    countSpan.textContent = "";
  }

  // æ¸²æŸ“è¡¨æ ¼
  tbody.innerHTML = "";
  if (matches.length === 0) {
    tbody.innerHTML = "<tr><td colspan='2'>ç„¡ç¬¦åˆç´€éŒ„</td></tr>";
  } else {
    matches.forEach(r => {
      tbody.insertAdjacentHTML("beforeend", `<tr><td>${r[6]}</td><td>${r[7]}</td></tr>`);
    });
  }
}

document.getElementById("dateSelect").addEventListener("change", runFilter);
document.getElementById("studentSelect").addEventListener("change", runFilter);

// åˆå§‹åŒ–è¼‰å…¥
loadCSV();
</script>

</body>
</html>
